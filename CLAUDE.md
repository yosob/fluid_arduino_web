# 液动控制系统 Web 上位机

基于 Vue3 + Element Plus 的气液泵控制系统 Web 上位机，通过 Web Serial API 与 Arduino 下位机通信。

**当前版本**: v1.6 (规划中)
**最后更新**: 2025-01-15

---

## 📋 项目概述

### 系统组成

这是一个**双通道气液泵控制系统**，包含：

- **2 个独立通道**：每个通道可独立控制
- **每通道 3 个泵**：1 个气泵 + 2 个液泵（同一时间只有 1 个泵工作）
- **双工作模式**：
  - **ONLINE 模式**：由 Web 上位机通过串口控制
  - **OFFLINE 模式**：通过物理开关和电位器手动控制
- **PWM 控制**：每个泵支持 0-255 占空比调节

### 核心功能

- ✅ 串口连接管理（Web Serial API）
- ✅ 双通道独立控制
- ✅ 实时状态监控
- ✅ PWM 功率调节（0-255）
- ✅ **指令模式**（手动控制单个泵）
- ✅ **循环模式**（列表式时序编程）
- ✅ **时间轴模式**（可视化时间轴编程）⭐ v1.6 规划中
- ✅ 心跳保活机制（3 秒超时保护）
- ✅ 紧急停止功能
- ✅ 固件升级功能（v1.5）

### 项目状态

| 模块 | 状态 | 完成度 |
|------|------|--------|
| 下位机 Arduino 代码 | ✅ 完成 | 100% |
| 通讯协议设计 | ✅ 完成 | 100% |
| Web 上位机开发 | ✅ 完成 | 100% |

---

## 🏗️ 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                     Web 上位机 (Vue3)                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │ Element Plus│  │ Pinia Store │  │ Web Serial API      │ │
│  │   UI 组件    │  │  状态管理    │  │   串口通信          │ │
│  └─────────────┘  └─────────────┘  └─────────────────────┘ │
└──────────────────────────┬──────────────────────────────────┘
                           │ UART (115200)
                           │ AA 55 | CMD | LEN | DATA | CRC8
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                  Arduino 下位机 (已完成)                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │ 协议解析器  │  │ 命令处理器  │  │  PWM 控制器         │ │
│  │protocol.cpp │  │command.cpp  │  │  6个PWM输出引脚     │ │
│  └─────────────┘  └─────────────┘  └─────────────────────┘ │
└──────────────────────────┬──────────────────────────────────┘
                           │ PWM 信号 (0-255)
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                        硬件层                              │
│  ┌──────────────────────┐      ┌──────────────────────┐   │
│  │   通道 1 (CH1)       │      │   通道 2 (CH2)       │   │
│  │  ├─ 气泵 (PIN 3)     │      │  ├─ 气泵 (PIN 9)     │   │
│  │  ├─ 液泵1 (PIN 5)    │      │  ├─ 液泵1 (PIN 10)   │   │
│  │  └─ 液泵2 (PIN 6)    │      │  └─ 液泵2 (PIN 11)   │   │
│  └──────────────────────┘      └──────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 数据流设计

```
用户操作 → UI组件 → Pinia Store → 协议封装器
                                     ↓
              Serial ← Web Serial ← CRC计算
                                     ↓
              Arduino 解析命令 → 硬件执行 (PWM输出)
                                     ↓
              状态反馈 → Store → UI 实时更新
```

---

## 💻 技术栈

### 前端框架
- **Vue 3**: 组合式 API (Composition API)
- **Vite**: 构建工具
- **Element Plus**: UI 组件库
- **Pinia**: 状态管理

### 核心技术
- **Web Serial API**: 浏览器原生串口通信
- **avrgirl-arduino**: Arduino 固件上传库（v1.5）
- **CRC8**: 数据校验算法
- **响应式状态**: Pinia Store + Vue Reactivity

### 开发工具
- **Node.js**: >= 18.0.0
- **npm**: >= 9.0.0
- **浏览器**: Chrome/Edge (支持 Web Serial API)

---

## 📁 项目目录结构

```
fliud_v0_web/
├── public/                          # 静态资源
│   ├── avrgirl-arduino.global.js   # 固件上传库 (v1.5)
│   └── firmware/                   # 固件文件
│       └── fluid_v1.hex
│
├── src/
│   ├── main.js                     # 应用入口
│   ├── App.vue                     # 根组件
│   │
│   ├── components/                 # Vue 组件
│   │   ├── DeviceControlPage.vue   # 设备控制页面
│   │   ├── FirmwareUpdateSimple.vue # 固件升级页面 (v1.5)
│   │   ├── ChannelPanel.vue        # 通道面板
│   │   ├── PumpControl.vue         # 泵控制组件
│   │   ├── SerialPortSelector.vue  # 串口选择器
│   │   ├── LoopManager.vue         # 循环模式管理器
│   │   ├── StatusIndicator.vue     # 状态指示器
│   │   ├── LogViewer.vue           # 通信日志查看器
│   │   └── EmergencyStop.vue       # 紧急停止按钮
│   │
│   ├── stores/                     # Pinia 状态管理
│   │   ├── connection.js           # 连接状态
│   │   ├── device.js               # 设备状态
│   │   ├── loop.js                 # 循环模式状态
│   │   └── log.js                  # 日志状态
│   │
│   ├── utils/                      # 工具函数
│   │   ├── protocol.js             # 协议封装
│   │   ├── crc8.js                 # CRC8 算法
│   │   └── serialManager.js        # 串口管理器
│   │
│   ├── composables/                # 组合式函数
│   │   ├── useHeartbeat.js         # 心跳保活
│   │   ├── useLoopControl.js       # 循环控制
│   │   └── useSerial.js            # 串口通信
│   │
│   ├── config/                     # 配置文件 (v1.5)
│   │   └── firmware.js             # 固件配置
│   │
│   └── assets/                     # 资源文件
│       └── styles/                 # 样式文件
│
├── reference/                      # 参考代码
│   └── yedong/                     # Arduino 下位机代码
│       ├── yedong.ino              # 主程序
│       ├── config.h                # 硬件配置
│       ├── protocol.h/cpp          # 协议实现
│       ├── command.h/cpp           # 命令处理
│       └── offline.h/cpp           # 手动模式
│
├── docs/                           # 文档目录
│   ├── timelinedoc/                # 时间轴功能文档 (v1.6 规划)
│   │   └── TIMELINE_FEATURE_PLAN.md  # 时间轴功能完整规划
│   │
│   ├── UPDATE_v1.5.md              # v1.5 更新说明
│   ├── UPDATE_v1.4.md              # v1.4 更新说明
│   ├── UPDATE_v1.3.md              # v1.3 更新说明
│   ├── UPDATE_v1.2.md              # v1.2 更新说明
│   ├── UPDATE_v1.1.md              # v1.1 更新说明
│   ├── FIRMWARE_UPLOAD_SUCCESS_GUIDE.md    # 固件上传详细指南
│   ├── FIRMWARE_UPLOAD_TECHNICAL_SUMMARY.md # 固件上传技术总结
│   ├── QUICK_START_FIRMWARE_UPLOAD.md      # 固件上传快速开始
│   ├── FAILED_ATTEMPTS_SUMMARY.md  # 失败尝试总结
│   └── ...
│
├── CLAUDE.md                       # 项目架构文档（本文档）
├── README.md                       # 项目说明
├── 功能需求.md                     # 需求文档
├── 液动通讯协议.md                 # 协议详细文档
├── package.json                    # 项目配置
└── vite.config.js                  # Vite 配置
```

---

## 🎨 UI 设计

### 页面结构（v1.6 三页面设计）

系统采用**选项卡切换**设计，包含三个主要功能页面：

```
┌─────────────────────────────────────────────────────────────────────┐
│  液动控制系统 v1.6                                        [🔌连接]  │
├─────────────────────────────────────────────────────────────────────┤
│  ┌──────────┬──────────┬──────────┐                                │
│  │🎮设备控制│📋固件升级│⏱️时间轴  │                                │
│  └──────────┴──────────┴──────────┘                                │
├─────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                                                               │  │
│  │              当前页面内容（根据选项卡切换）                     │  │
│  │                                                               │  │
│  └───────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

**页面说明**:
- **🎮 设备控制**: 手动控制、循环模式、实时监控
- **📋 固件升级**: Arduino 固件上传和更新
- **⏱️ 时间轴**: 可视化时间轴编程（v1.6 新增）⭐

### 页面1: 设备控制（v1.3 三栏布局）

```
┌─────────────────────────────────────────────────────────────┐
│  液动控制系统 v1.5                        [🔌连接串口] [❌断开] │
├──────────────────┬──────────────────┬─────────────────────┤
│  左侧栏 (33%)    │  中间栏 (33%)    │  右侧栏 (33%)      │
│  ┌────────────┐  │  ┌────────────┐  │  ┌───────────────┐│
│  │📊 设备状态 │  │  │ 🔄 循环模式│  │  │ 📜 通信日志   ││
│  │            │  │  │            │  │  │               ││
│  │ 硬件版本   │  │  │ 控制按钮  │  │  │ 实时日志      ││
│  │ 固件版本   │  │  │            │  │  │               ││
│  │ 设备名称   │  │  │ 序列表     │  │  │ 十六进制显示  ││
│  │ 心跳状态   │  │  │            │  │  │               ││
│  └────────────┘  │  └────────────┘  │  │ 自动滚动      ││
│                  │                  │  │               ││
│  📍 通道 1       │  进度信息        │  └───────────────┘│
│  ┌─────────┐    │  ┌────────────┐  │                     │
│  │ 💨💧💧  │    │  │第2条/共3条│  │                     │
│  │气泵 液1 液2│  │  │已循环5次  │  │                     │
│  └─────────┘    │  └────────────┘  │                     │
│                  │                  │                     │
│  📍 通道 2       │                  │                     │
│  ┌─────────┐    │                  │                     │
│  │ 💨💧💧  │    │                  │                     │
│  │气泵 液1 液2│  │                  │                     │
│  └─────────┘    │                  │                     │
│                  │                  │                     │
│  🛑 紧急停止     │                  │                     │
└──────────────────┴──────────────────┴─────────────────────┘
```

#### 三栏布局说明
- **左侧栏 (33%)**: 设备状态 + 双通道控制 + 紧急停止
- **中间栏 (33%)**: 循环模式管理
- **右侧栏 (33%)**: 实时通信日志

### 通道控制组件（横向布局）

```
┌─────────────────────────────────────────────┐
│  📍 通道 1                                   │
├─────────┬─────────┬─────────┬───────────────┤
│  💨 气泵 │  💧 液泵1│  💧 液泵2│  控制说明     │
│         │         │         │               │
│ [▓▓▓░░] │ [▓▓▓▓▓] │ [░░░░░] │ 同一时间只有  │
│  PWM:150│  PWM:200│  PWM:0  │ 一个泵工作    │
│  ✓运行中│  已停止 │  已停止  │               │
└─────────┴─────────┴─────────┴───────────────┘
```

**特点:**
- ✅ 横向排列，紧凑布局
- ✅ 三个泵并排显示
- ✅ 便于对比状态
- ✅ PWM 滑块可调节
- ✅ 实时状态显示

### 页面2: 固件升级（v1.5）

```
┌─────────────────────────────────────────────────────────────────────┐
│  💾 Arduino 固件升级                                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  📦 固件信息                                                 │   │
│  │  ├─ 固件版本: fluid V1.0                                    │   │
│  │  ├─ 发布日期: 2025-01-14                                    │   │
│  │  ├─ 文件大小: 19.17 KB                                      │   │
│  │  └─ 说明: 液动控制系统官方固件                              │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  📋 使用说明                                                 │   │
│  │  1. 确保 Arduino 通过 USB 连接到电脑                         │   │
│  │  2. 点击"开始上传"按钮                                      │   │
│  │  3. 在弹出的对话框中选择串口                               │   │
│  │  4. 等待上传完成                                            │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  [开始上传]                                                  │   │
│  │                                                             │   │
│  │  上传进度: 100% ████████████████████████████████████       │   │
│  │  已上传: 19.17 KB | 用时: 00:08 | 速度: 2.4 KB/s          │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  📋 日志输出                                                 │   │
│  │  [13:05:40] 正在加载固件文件...                              │   │
│  │  [13:05:40] ✓ 固件文件加载成功                               │   │
│  │  [13:05:48] ✓ 固件上传成功！                                 │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

#### 固件升级特性
- ✅ 使用 avrgirl-arduino 库
- ✅ 自动复位和上传
- ✅ 实时进度显示
- ✅ 详细日志输出
- ✅ 100% 成功率

### 页面3: 时间轴编程（v1.6 规划中）

```
┌─────────────────────────────────────────────────────────────────────┐
│  ⏱️ 可视化时间轴编程                                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  📊 时间轴配置                                              │   │
│  │  总时长: [10秒] ▼  循环次数: [3次]  间隔: [0.5秒]            │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  通道1: 💨气泵 💧液泵1 💧液泵2                            │   │
│  │                                                             │   │
│  │  0s    2s    4s    6s    8s    10s                          │   │
│  │  │     │     │     │     │     │                           │   │
│  │  ▌─────▌─────▌─────▌─────▌─────▌                           │   │
│  │  [▓▓▓░░][▓▓▓░░][░░░░░][▓▓▓▓▓][▓▓▓░░]  ← 点击编辑时间段    │   │
│  │   PWM150  PWM200   OFF    PWM180  PWM150                     │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  通道2: 💨气泵 💧液泵1 💧液泵2                            │   │
│  │  (同样的时间轴布局)                                          │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  🎬 控制面板                                                │   │
│  │  [▶️ 执行] [⏸️ 暂停] [⏹️ 停止] [🔄 重置] [💾 保存] [📂 加载] │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  📊 执行进度                                                │   │
│  │  当前进度: ████░░░░░░░░░░ 40% (第2段 / 共5段)                 │   │
│  │  当前循环: 第2次 / 共3次                                    │   │
│  │  剩余时间: 00:06                                            │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

#### 时间轴功能特性
- ✅ **可视化编辑** - 点击、拖拽调整时间段
- ✅ **实时预览** - 所见即所得的时间轴设计
- ✅ **多通道同步** - 双通道独立或同步视图
- ✅ **智能调度** - 自动转换为下位机指令
- ✅ **保存/加载** - 导入导出时间轴配置文件
- ✅ **模板库** - 预设常见动画效果（波浪、呼吸、闪烁等）

#### 交互设计
- **点击编辑**: 点击时间段弹出编辑对话框
- **拖拽边界**: 调整时间段开始/结束时间
- **拖拽移动**: 移动整段到新位置
- **缩放视图**: 1x/2x/4x 缩放精确编辑
- **实时反馈**: 执行时高亮当前段

#### 技术实现
- **时间轴引擎**: 基于请求动画帧的实时调度器
- **数据转换**: 时间轴 → 循环模式指令序列
- **状态管理**: 新增 `timeline.js` Pinia Store
- **组件架构**: 模块化时间轴组件系统

> 📖 **详细规划文档**: `docs/timelinedoc/TIMELINE_FEATURE_PLAN.md`

---

## 🎯 核心组件关系

### 页面容器组件
```
App.vue (根组件)
├─ 选项卡切换
│
├─ 设备控制页面 (DeviceControlPage)
│  ├─ 串口选择器 (SerialPortSelector)
│  ├─ 状态指示器 (StatusIndicator)
│  ├─ 通道面板 (ChannelPanel)
│  │  └─ 泵控制 (PumpControl) × 3
│  ├─ 循环管理器 (LoopManager)
│  ├─ 日志查看器 (LogViewer)
│  └─ 紧急停止 (EmergencyStop)
│
├─ 固件升级页面 (FirmwareUpdateSimple)
│  └─ 固件上传控制器
│
└─ 时间轴页面 (TimelinePage) ⭐ v1.6 新增
   ├─ 时间轴配置 (TimelineConfig)
   ├─ 通道时间轴 (ChannelTimeline)
   │  ├─ 时间段块 (TimeSegment)
   │  ├─ 段编辑器 (SegmentEditor)
   │  └─ 时间刻度 (TimeRuler)
   ├─ 播放控制 (TimelineControls)
   ├─ 进度显示 (ProgressDisplay)
   └─ 状态管理 (TimelineStore)
```

### 组件职责划分

#### 设备控制相关
- **DeviceControlPage**: 设备控制页面容器，整合所有控制组件
- **SerialPortSelector**: 串口连接/断开控制
- **StatusIndicator**: 设备状态显示（版本、名称、心跳）
- **ChannelPanel**: 通道面板容器，显示单个通道的所有泵
- **PumpControl**: 单个泵的控制卡片（启动/停止、PWM调节）
- **LoopManager**: 循环模式管理（添加/删除/开始/停止）
- **LogViewer**: 实时通信日志查看器
- **EmergencyStop**: 紧急停止按钮（最高优先级）

#### 固件升级相关
- **FirmwareUpdateSimple**: 固件升级页面
  - 固件信息展示
  - 固件上传控制
  - 进度显示
  - 日志输出

#### 时间轴相关（v1.6 新增）⭐
- **TimelinePage**: 时间轴页面容器
  - 整合所有时间轴相关组件
  - 协调编辑和执行状态

- **TimelineConfig**: 时间轴配置组件
  - 总时长设置
  - 循环次数设置
  - 时间间隔设置

- **ChannelTimeline**: 单个通道的时间轴组件
  - 渲染时间段块
  - 处理拖拽和点击事件
  - 支持缩放视图

- **TimeSegment**: 时间段块组件
  - 显示时间段信息
  - 支持拖拽调整
  - 执行时动画效果

- **SegmentEditor**: 时间段编辑对话框
  - 编辑开始/结束时间
  - 选择泵类型和PWM值
  - 删除/复制功能

- **TimeRuler**: 时间刻度尺组件
  - 显示时间刻度
  - 支持缩放切换
  - 网格线对齐

- **TimelineControls**: 播放控制面板
  - 执行/暂停/停止按钮
  - 重置功能
  - 保存/加载配置

- **ProgressDisplay**: 执行进度显示
  - 当前进度条
  - 循环次数统计
  - 剩余时间计算

### Pinia Store 设计

```
stores/
├─ connection.js    # 连接状态管理
│  ├─ connected: Boolean
│  ├─ port: SerialPort
│  └─ actions: connect(), disconnect()
│
├─ device.js        # 设备状态管理
│  ├─ hardwareVersion: String
│  ├─ firmwareVersion: String
│  ├─ name: String
│  ├─ channels: Object (ch1, ch2)
│  └─ actions: updateChannel(), reset()
│
├─ loop.js          # 循环模式状态管理
│  ├─ isRunning: Boolean
│  ├─ isPaused: Boolean
│  ├─ currentIndex: Number
│  ├─ totalSteps: Number
│  ├─ loopCount: Number
│  ├─ sequence: Array
│  └─ actions: start(), pause(), stop(), addStep()
│
└─ log.js           # 日志状态管理
   ├─ logs: Array
   └─ actions: addLog(), clearLogs()
│
└─ timeline.js      # 时间轴状态管理 (v1.6 新增) ⭐
   ├─ config: Object        # 时间轴配置
   │  ├─ totalDuration: Number
   │  ├─ loopCount: Number
   │  ├─ interval: Number
   │  └─ gridSize: Number
   │
   ├─ channels: Object      # 通道时间轴数据
   │  ├─ ch1: Array          # 通道1时间段数组
   │  └─ ch2: Array          # 通道2时间段数组
   │
   ├─ execution: Object     # 执行状态
   │  ├─ isRunning: Boolean
   │  ├─ isPaused: Boolean
   │  ├─ currentLoop: Number
   │  ├─ currentSegment: Object
   │  └─ progress: Number
   │
   └─ actions:
      ├─ addSegment(channel, segment)
      ├─ updateSegment(id, data)
      ├─ deleteSegment(id)
      ├─ moveSegment(id, newTime)
      ├─ startExecution()
      ├─ pauseExecution()
      ├─ stopExecution()
      ├─ saveTimeline(name)
      └─ loadTimeline(data)
```

---

## 🔌 通讯协议

### 数据帧格式

```
┌─────┬─────┬─────┬─────┬─────────┬─────┐
│0xAA │0x55│ CMD │ LEN │  DATA   │CRC8 │
└─────┴─────┴─────┴─────┴─────────┴─────┘
 帧头   命令   长度    数据     校验
 2字节  1字节  1字节  N字节    1字节
```

### 核心命令映射表

| 命令码 | 名称 | 方向 | 功能 |
|:-----:|------|:-----:|------|
| **下行命令（上位机→下位机）** |
| 0x10 | SET_PUMP | ↓ | 启动指定泵（通道+泵型+PWM） |
| 0x11 | STOP_CHANNEL | ↓ | 停止指定通道 |
| 0x12 | STOP_ALL | ↓ | 紧急停止所有泵（最高优先级） |
| 0x14 | LOOP_ADD | ↓ | 添加循环时序指令 |
| 0x15 | LOOP_CLEAR | ↓ | 清空时序表 |
| 0x16 | LOOP_START | ↓ | 开始循环执行 |
| 0x17 | LOOP_STOP | ↓ | 停止循环执行 |
| 0x18 | LOOP_PAUSE | ↓ | 暂停循环 |
| 0x19 | LOOP_RESUME | ↓ | 继续循环 |
| 0x20 | GET_VERSION | ↓ | 获取版本信息 |
| 0x21 | GET_STATUS | ↓ | 查询运行状态 |
| 0x22 | GET_LOOP_STATUS | ↓ | 查询循环状态 |
| **上行命令（下位机→上位机）** |
| 0x30 | VERSION_RSP | ↑ | 版本信息响应 |
| 0x31 | STATUS_RSP | ↑ | 状态查询响应 |
| 0x32 | LOOP_STATUS_RSP | ↑ | 循环状态响应 |
| 0x40 | ACK | ↑ | 确认响应 |
| 0x41 | NACK | ↑ | 错误响应 |
| **双向命令** |
| 0x50 | HEARTBEAT | ↔ | 心跳包（1秒间隔） |

### CRC8 校验

- **多项式**: 0x07 (x^8 + x^2 + x + 1)
- **初始值**: 0x00
- **校验范围**: 命令 + 长度 + 数据

详细协议说明请参考：`液动通讯协议.md`

---

## 🔐 安全机制

### 1. 心跳保活
- **发送频率**: 每 1 秒
- **超时时间**: 3 秒无响应自动停机
- **功能**: 通信中断时自动停止所有泵

### 2. CRC8 校验
- 所有数据帧必须通过 CRC8 校验
- 校验失败自动丢弃并记录错误
- 确保数据完整性

### 3. 错误处理
| 错误码 | 错误类型 |
|:-----:|---------|
| 0x01 | CRC 校验错误 |
| 0x02 | 命令不支持 |
| 0x03 | 参数错误 |
| 0x04 | 通道号错误 |
| 0x05 | 泵类型错误 |
| 0x06 | 硬件故障 |
| 0x07 | 时序表已满 |
| 0x08 | 模式冲突 |
| 0x09 | 泵冲突 |

### 4. 紧急停止
- 最高优先级命令（0x12）
- 响应时间 < 10ms
- 立即停止所有泵
- 独立按钮，一键触发

---

## 🚀 开发指南

### 环境要求
- **Node.js**: >= 18.0.0
- **浏览器**: Chrome/Edge 89+（支持 Web Serial API）
- **硬件**: Arduino 开发板（已烧录下位机代码）

### 快速开始
```bash
# 1. 安装依赖
npm install

# 2. 启动开发服务器
npm run dev

# 3. 打开浏览器访问
# http://localhost:5173

# 4. 连接串口并测试
```

### 浏览器兼容性
Web Serial API 目前仅在基于 Chromium 的浏览器中可用：
- ✅ Chrome 89+
- ✅ Edge 89+
- ✅ Opera 75+
- ❌ Firefox（暂不支持）
- ❌ Safari（暂不支持）

### HTTPS 要求
Web Serial API 只能在安全上下文中使用：
- 本地开发：`http://localhost` 或 `http://127.0.0.1`
- 生产环境：必须使用 `https://`

---

## 📝 版本历史

### v1.6 (规划中) - 可视化时间轴编程 ⭐
- 📋 **可视化时间轴** - 拖拽式时间轴编辑界面
- 📋 **实时预览** - 所见即所得的动画设计
- 📋 **智能调度** - 自动转换为下位机指令序列
- 📋 **保存/加载** - 时间轴配置文件管理
- 📋 **模板库** - 预设常见动画效果
- 📋 **执行引擎** - 基于请求动画帧的实时调度
- 📋 **进度反馈** - 实时显示执行进度和状态
- **状态**: 📋 规划中
- **预计开发**: 7-12 天
- **详细文档**: `docs/timelinedoc/TIMELINE_FEATURE_PLAN.md`

### v1.5 (2025-01-15) - 固件上传功能
- ✅ 基于 avrgirl-arduino 的固件上传功能
- ✅ 使用 avrgirl-arduino.global.js（浏览器版本）
- ✅ 完整的固件上传界面和进度显示
- ✅ 项目清理和优化（删除17个失败文件）
- ✅ 更新项目架构文档

### v1.4 (2025-01-14) - 多页面设计
- ✅ 多页面设计（选项卡切换）
- ✅ 固件升级功能（初始版本）
- ✅ 循环状态查询机制
- ✅ 固件内置管理

### v1.3 (2025-01-13) - 优化提升
- ✅ 完善初始化信息过滤
- ✅ 强力清空缓存功能
- ✅ 双PWM条显示（设置PWM + 实际PWM）
- ✅ 版本信息100%获取成功

### v1.2 (2025-01-12) - 横向布局
- ✅ 通道控制横向排列
- ✅ 版本信息获取修复
- ✅ 界面优化

### v1.1 (2025-01-11) - 三栏布局
- ✅ 三栏布局设计
- ✅ 实时通信日志
- ✅ 自动状态刷新（1秒轮询）

### v1.0 (初始版本)
- ✅ 基础串口通信
- ✅ 简单泵控制界面

---

## 📚 相关文档

### 核心文档
- **`CLAUDE.md`**: 项目架构文档（本文档）
- **`README.md`**: 项目说明和使用指南
- **`功能需求.md`**: 系统功能需求说明
- **`液动通讯协议.md`**: 详细的协议定义和示例

### 技术文档
- **`docs/timelinedoc/TIMELINE_FEATURE_PLAN.md`**: v1.6 时间轴功能完整规划 ⭐ NEW
- **`docs/FIRMWARE_UPLOAD_SUCCESS_GUIDE.md`**: 固件上传完整实现指南
- **`docs/FIRMWARE_UPLOAD_TECHNICAL_SUMMARY.md`**: 固件上传技术总结
- **`docs/QUICK_START_FIRMWARE_UPLOAD.md`**: 固件上传快速开始
- **`docs/FAILED_ATTEMPTS_SUMMARY.md`**: 失败尝试总结

### 版本更新文档
- **`docs/UPDATE_v1.5.md`**: v1.5 更新说明
- **`docs/UPDATE_v1.4.md`**: v1.4 更新说明
- **`docs/UPDATE_v1.3.md`**: v1.3 更新说明
- **`docs/UPDATE_v1.2.md`**: v1.2 更新说明
- **`docs/UPDATE_v1.1.md`**: v1.1 更新说明

### 故障排除
- **`docs/FIX_DISCONNECT.md`**: 断开串口错误修复
- **`docs/FIXES.md`**: 常见问题快速修复

---

## 📁 组件组织规范

### 目录结构原则

本项目采用**按功能模块分组**的方式组织组件，这是 Vue 官方推荐的业界最佳实践。

### 目录结构

```
src/components/
├── device/                   # 设备控制模块
│   ├── ChannelPanel.vue       # 通道面板
│   ├── PumpControl.vue        # 泵控制
│   ├── LoopManager.vue        # 循环管理器
│   ├── LogViewer.vue          # 日志查看器
│   ├── EmergencyStop.vue      # 紧急停止
│   ├── SerialPortSelector.vue # 串口选择器
│   └── StatusIndicator.vue    # 状态指示器
│
├── firmware/                 # 固件升级模块
│   └── FirmwareUpdateSimple.vue
│
├── timeline/                  # 时间轴模块
│   ├── ChannelTimeline.vue    # 通道时间轴
│   └── TimeRuler.vue          # 时间刻度
│
└── pages/                     # 页面容器
    ├── DeviceControlPage.vue
    ├── FirmwareUpdateSimple.vue
    └── TimelinePage.vue
```

### 组织原则

#### 1. 按功能模块分组 ✅

**规则**: 每个功能模块对应一个子目录

- **`device/`** - 设备控制相关的所有组件
- **`firmware/`** - 固件升级相关的所有组件
- **`timeline/`** - 时间轴编程相关的所有组件

**优点**:
- ✅ 清晰的功能边界
- ✅ 高内聚、低耦合
- ✅ 便于团队协作
- ✅ 易于维护和扩展

#### 2. 页面容器独立 ✅

**规则**: 页面级组件放在 `pages/` 目录

- 页面组件负责整合各自模块的子组件
- 管理页面级状态
- 处理页面级布局

**依赖关系**:
```
pages/DeviceControlPage.vue
  └─ 使用 → device/* 组件

pages/FirmwareUpdateSimple.vue
  └─ 使用 → firmware/* 组件

pages/TimelinePage.vue
  └─ 使用 → timeline/* 组件
```

#### 3. 同目录组件使用相对路径 ✅

**规则**: 同一目录内的组件相互引用使用相对路径

```javascript
// ✅ 正确 - 同目录相对引用
import PumpControl from './PumpControl.vue'

// ❌ 错误 - 不应使用绝对路径
import PumpControl from '@/components/device/PumpControl.vue'
```

#### 4. 跨目录组件使用绝对路径 ✅

**规则**: 不同目录的组件引用使用 `@/components/` 别名

```javascript
// ✅ 正确 - 跨目录绝对引用
import ChannelTimeline from '@/components/timeline/ChannelTimeline.vue'

// ❌ 错误 - 不应使用相对路径（如 ../../timeline/）
```

#### 5. 组件命名规范 ✅

**文件命名**:
- 使用 PascalCase
- 文件名与组件名一致
- 例如: `DeviceControlPage.vue`

**目录命名**:
- 使用小写
- 多个单词用连字符连接
- 例如: `device/`, `firmware/`

### 新增组件指南

#### 添加新功能模块

1. 在 `src/components/` 下创建新的模块目录
   ```bash
   mkdir src/components/new-feature
   ```

2. 将相关组件放入该目录
   ```
   src/components/new-feature/
   ├── FeaturePage.vue
   ├── FeatureComponent1.vue
   └── FeatureComponent2.vue
   ```

3. 在 `src/App.vue` 中导入页面组件
   ```javascript
   import FeaturePage from '@/components/new-feature/FeaturePage.vue'
   ```

#### 添加页面组件

如果组件是**页面容器**（整合其他子组件），放在对应模块目录下：
- ✅ `device/DeviceControlPage.vue` （在 device/ 中）
- ✅ `firmware/FirmwareUpdateSimple.vue` （在 firmware/ 中）

或者，如果页面**跨越多个模块**，放在 `pages/` 目录：
- ✅ `pages/TimelinePage.vue` （跨模块的复杂页面）

### 参考规范

- ✅ [Vue 3 风格指南](https://vuejs.org/style-guide/)
- ✅ [Element Plus 组件开发规范](https://element-plus.org/)
- ✅ [Vue 项目结构最佳实践](https://github.com/pillarjs/path-to-profit)

---

## 🛠️ 开发规范

### 代码风格
- 使用 ESLint + Prettier
- 组件命名：PascalCase
- 文件命名：kebab-case
- 组合式函数：use 前缀

### Git 提交规范
```
feat: 新功能
fix: 修复bug
docs: 文档更新
style: 代码格式调整
refactor: 重构
test: 测试相关
chore: 构建/工具变更
```

---

## 📞 技术支持

### 常见问题

**Q: Web Serial API 不工作？**
A:
1. 确保使用 Chrome/Edge 浏览器（89+）
2. 确保通过 `https://` 或 `http://localhost` 访问
3. 更新浏览器到最新版本

**Q: 串口连接失败？**
A:
1. 检查 Arduino 是否正确连接
2. 确认端口未被其他程序占用
3. 尝试重新插拔 USB 线

**Q: 固件上传失败？**
A:
1. 确保使用 avrgirl-arduino.global.js
2. 检查固件文件路径是否正确
3. 关闭 Arduino IDE 串口监视器
4. 参考：`docs/FIRMWARE_UPLOAD_SUCCESS_GUIDE.md`

---

## 📄 许可证

本项目为内部项目，版权归项目组所有。

---

**版本**: 1.6 (规划中)
**最后更新**: 2025-01-15
**协议版本**: PWM 直接控制（0-255）
**维护者**: 液动工具包项目组
