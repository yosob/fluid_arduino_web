# 液动控制系统 Web 上位机

基于 Vue3 + Element Plus 的气液泵控制系统 Web 上位机，通过 Web Serial API 与 Arduino 下位机通信。

---

## 📋 项目概述

### 系统组成
这是一个双通道气液泵控制系统，包含：
- **2 个独立通道**：每个通道可独立控制
- **每通道 3 个泵**：1 个气泵 + 2 个液泵（同一时间只有 1 个泵工作）
- **双工作模式**：
  - **ONLINE 模式**：由 Web 上位机通过串口控制
  - **OFFLINE 模式**：通过物理开关和电位器手动控制
- **PWM 控制**：每个泵支持 0-255 占空比调节

### 核心功能
- ✅ 串口连接管理（Web Serial API）
- ✅ 双通道独立控制
- ✅ 实时状态监控
- ✅ PWM 功率调节（0-255）
- ✅ 指令模式（手动控制单个泵）
- ✅ 循环模式（时序编程自动执行）
- ✅ 心跳保活机制（3 秒超时保护）
- ✅ 紧急停止功能

### 项目状态
| 模块 | 状态 | 完成度 |
|------|------|--------|
| 下位机 Arduino 代码 | ✅ 完成 | 100% |
| 通讯协议设计 | ✅ 完成 | 100% |
| Web 上位机开发 | 🚧 待开发 | 0% |

---

## 🏗️ 系统架构

### 整体架构图
```
┌─────────────────────────────────────────────────────────────┐
│                     Web 上位机 (Vue3)                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │ Element Plus│  │ Pinia Store │  │ Web Serial API      │ │
│  │   UI 组件    │  │  状态管理    │  │   串口通信          │ │
│  └─────────────┘  └─────────────┘  └─────────────────────┘ │
└──────────────────────────┬──────────────────────────────────┘
                           │ UART (115200)
                           │ AA 55 | CMD | LEN | DATA | CRC8
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                  Arduino 下位机 (已完成)                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │ 协议解析器  │  │ 命令处理器  │  │  PWM 控制器         │ │
│  │protocol.cpp │  │command.cpp  │  │  6个PWM输出引脚     │ │
│  └─────────────┘  └─────────────┘  └─────────────────────┘ │
└──────────────────────────┬──────────────────────────────────┘
                           │ PWM 信号 (0-255)
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                        硬件层                              │
│  ┌──────────────────────┐      ┌──────────────────────┐   │
│  │   通道 1 (CH1)       │      │   通道 2 (CH2)       │   │
│  │  ├─ 气泵 (PIN 3)     │      │  ├─ 气泵 (PIN 9)     │   │
│  │  ├─ 液泵1 (PIN 5)    │      │  ├─ 液泵1 (PIN 10)   │   │
│  │  └─ 液泵2 (PIN 6)    │      │  └─ 液泵2 (PIN 11)   │   │
│  └──────────────────────┘      └──────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 数据流设计
```
用户操作 → UI组件 → Pinia Store → 协议封装器
                                     ↓
              Serial ← Web Serial ← CRC计算
                                     ↓
              Arduino 解析命令 → 硬件执行 (PWM输出)
                                     ↓
              状态反馈 → Store → UI 实时更新
```

---

## 🔌 通讯协议

### 数据帧格式
```
┌─────┬─────┬─────┬─────┬─────────┬─────┐
│0xAA │0x55│ CMD │ LEN │  DATA   │CRC8 │
└─────┴─────┴─────┴─────┴─────────┴─────┘
 帧头   命令   长度    数据     校验
 2字节  1字节  1字节  N字节    1字节
```

### 核心命令映射表
| 命令码 | 名称 | 方向 | 功能 |
|:-----:|------|:-----:|------|
| **下行命令（上位机→下位机）** |
| 0x10 | SET_PUMP | ↓ | 启动指定泵（通道+泵型+PWM） |
| 0x11 | STOP_CHANNEL | ↓ | 停止指定通道 |
| 0x12 | STOP_ALL | ↓ | 紧急停止所有泵（最高优先级） |
| 0x14 | LOOP_ADD | ↓ | 添加循环时序指令 |
| 0x15 | LOOP_CLEAR | ↓ | 清空时序表 |
| 0x16 | LOOP_START | ↓ | 开始循环执行 |
| 0x17 | LOOP_STOP | ↓ | 停止循环执行 |
| 0x18 | LOOP_PAUSE | ↓ | 暂停循环 |
| 0x19 | LOOP_RESUME | ↓ | 继续循环 |
| 0x20 | GET_VERSION | ↓ | 获取版本信息 |
| 0x21 | GET_STATUS | ↓ | 查询运行状态 |
| 0x22 | GET_LOOP_STATUS | ↓ | 查询循环状态 |
| **上行命令（下位机→上位机）** |
| 0x30 | VERSION_RSP | ↑ | 版本信息响应 |
| 0x31 | STATUS_RSP | ↑ | 状态查询响应 |
| 0x32 | LOOP_STATUS_RSP | ↑ | 循环状态响应 |
| 0x40 | ACK | ↑ | 确认响应 |
| 0x41 | NACK | ↑ | 错误响应 |
| **双向命令** |
| 0x50 | HEARTBEAT | ↔ | 心跳包（1秒间隔） |

### CRC8 校验算法
- **多项式**: 0x07 (x^8 + x^2 + x + 1)
- **初始值**: 0x00
- **校验范围**: 命令 + 长度 + 数据

```javascript
function calcCRC8(data) {
  let crc = 0x00
  for (let byte of data) {
    crc ^= byte
    for (let i = 0; i < 8; i++) {
      if (crc & 0x80) {
        crc = (crc << 1) ^ 0x07
      } else {
        crc <<= 1
      }
      crc &= 0xFF
    }
  }
  return crc
}
```

---

## 💻 技术栈

### 前端框架
- **Vue 3**: 组合式 API (Composition API)
- **Vite**: 构建工具
- **Element Plus**: UI 组件库
- **Pinia**: 状态管理

### 核心技术
- **Web Serial API**: 浏览器原生串口通信
- **CRC8**: 数据校验算法
- **响应式状态**: Pinia Store + Vue Reactivity

### 开发工具
- **Node.js**: >= 18.0.0
- **npm**: >= 9.0.0
- **浏览器**: Chrome/Edge (支持 Web Serial API)

---

## 📁 项目目录结构

```
fliud_v0_web/
├── public/                       # 静态资源
│   ├── index.html               # HTML 模板
│   └── favicon.ico
│
├── src/
│   ├── main.js                  # 应用入口
│   ├── App.vue                  # 根组件
│   │
│   ├── components/              # Vue 组件
│   │   ├── ChannelPanel.vue     # 通道面板
│   │   ├── PumpControl.vue      # 泵控制组件
│   │   ├── SerialPortSelector.vue # 串口选择器
│   │   ├── LoopManager.vue      # 循环模式管理器
│   │   ├── StatusIndicator.vue  # 状态指示器
│   │   └── EmergencyStop.vue    # 紧急停止按钮
│   │
│   ├── stores/                  # Pinia 状态管理
│   │   ├── connection.js        # 连接状态
│   │   ├── device.js            # 设备状态
│   │   └── loop.js              # 循环模式状态
│   │
│   ├── utils/                   # 工具函数
│   │   ├── protocol.js          # 协议封装
│   │   ├── crc8.js              # CRC8 算法
│   │   └── serialManager.js     # 串口管理器
│   │
│   ├── composables/             # 组合式函数
│   │   ├── useHeartbeat.js      # 心跳保活
│   │   ├── useLoopControl.js    # 循环控制
│   │   └── useSerial.js         # 串口通信
│   │
│   └── assets/                  # 资源文件
│       └── styles/              # 样式文件
│
├── reference/                   # 参考代码
│   └── yedong/                  # Arduino 下位机代码
│       ├── yedong.ino           # 主程序
│       ├── config.h             # 硬件配置
│       ├── protocol.h/cpp       # 协议实现
│       ├── command.h/cpp        # 命令处理
│       └── offline.h/cpp        # 手动模式
│
├── 功能需求.md                   # 需求文档
├── 液动通讯协议.md               # 协议详细文档
├── CLAUDE.md                    # 本文件
├── package.json                 # 项目配置
├── vite.config.js               # Vite 配置
└── README.md                    # 项目说明
```

---

## 🎨 UI 设计

### 页面结构（v1.4 多页面设计）

系统采用**选项卡切换**设计，包含两个主要功能页面：

```
┌─────────────────────────────────────────────────────────────────────┐
│  液动控制系统 v1.0                                      [🔌连接] [❌]  │
├─────────────────────────────────────────────────────────────────────┤
│  ┌────────────┬────────────┐                                        │
│  │ 🎮 设备控制 │ 💾 固件升级 │                                        │
│  └────────────┴────────────┘                                        │
├─────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                                                               │  │
│  │              当前页面内容（根据选项卡切换）                     │  │
│  │                                                               │  │
│  │  【页面1: 设备控制】或【页面2: 固件升级】                       │  │
│  │                                                               │  │
│  └───────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

#### 页面切换特性
- ✅ 使用 `el-tabs` 组件实现
- ✅ 顶部卡片式选项卡
- ✅ 支持图标和文字显示
- ✅ 切换状态保持（不会丢失数据）
- ✅ 移动端友好（可横向滚动）

---

### 页面1: 设备控制（v1.3 三栏布局）
```
┌─────────────────────────────────────────────────────────────┐
│  液动控制系统 v1.0                        [🔌连接串口] [❌断开] │
├──────────────────┬──────────────────┬─────────────────────┤
│  左侧栏 (33%)    │  中间栏 (33%)    │  右侧栏 (33%)      │
│  ┌────────────┐  │  ┌────────────┐  │  ┌───────────────┐│
│  │📊 设备状态 │  │  │ 🔄 循环模式│  │  │ 📜 通信日志   ││
│  │┌─────────┐│  │  │            │  │  │               ││
│  ││硬件:1.0 ││  │  │ 控制按钮  │  │  │ [14:30:25]    ││
│  ││固件:1.0 ││  │  │            │  │  │ [发送] AA 55 ││
│  ││名称:V0 ││  │  │ 序列表     │  │  │ 10 03 01 99  ││
│  │└─────────┘│  │  │            │  │  │               ││
│  └────────────┘  │  └────────────┘  │  │ [14:30:25]    ││
│                  │                  │  │  │ [接收] AA 55 ││
│  📍 通道 1       │  进度信息        │  │  │ 40 01 10 8C  ││
│  ┌───┬───┬───┐ │  ┌────────────┐  │  │               ││
│  │💨 │💧 │💧 │ │  │第2条/共3条│  │  │ [14:30:26]    ││
│  │气泵│液1│液2│ │  │已循环5次  │  │  │ [成功] 响应   ││
│  │[░]│[▓]│[░]│ │  └────────────┘  │  │               ││
│  └───┴───┴───┘ │                  │  │ [14:30:27]    ││
│                  │                  │  │  │ [信息] 清空... ││
│  📍 通道 2       │                  │  │  │               ││
│  ┌───┬───┬───┐ │                  │  │  │ ...           ││
│  │💨 │💧 │💧 │ │                  │  │  │               ││
│  │气泵│液1│液2│ │                  │  │  └───────────────┘│
│  │[░]│[░]│[▓]│ │                  │  │                     │
│  └───┴───┴───┘ │                  │  │                     │
│                  │                  │  │                     │
│  🛑 紧急停止     │                  │  │                     │
└──────────────────┴──────────────────┴─────────────────────┘
```

### 布局说明

#### 三栏设计
- **左侧栏 (33%)**: 设备状态 + 双通道控制 + 紧急停止
- **中间栏 (33%)**: 循环模式管理
- **右侧栏 (33%)**: 实时通信日志

#### 通道控制（横向布局）
```
┌─────────┬─────────┬─────────┐
│ 💨 气泵 │ 💧 液泵1│ 💧 液泵2│
│ [▓▓░░░] │ [▓▓▓▓▓] │ [░░░░░] │
│ 运行中 ✓ │ 已停止   │ 已停止   │
└─────────┴─────────┴─────────┘
```

**特点:**
- ✅ 横向排列，更紧凑
- ✅ 三个泵并排显示
- ✅ 便于对比状态
- ✅ 适合宽屏显示

### 组件功能说明

#### 页面容器组件
- **App.vue**: 主应用容器
  - 顶部标题栏
  - 选项卡切换（设备控制/固件升级）
  - 页面内容区域

#### 页面1: 设备控制组件
- **DeviceControlPage.vue**: 设备控制页面容器
  - 整合所有设备控制相关组件

- **ChannelPanel.vue**: 通道面板容器，显示单个通道的所有泵
- **PumpControl.vue**: 单个泵的控制卡片（横向布局）
  - 点击启动/停止
  - 设置PWM滑块（始终可拖动）
  - 当前PWM显示（只读）
  - 实时状态显示

#### 功能组件
- **SerialPortSelector.vue**: 串口连接/断开控制
- **StatusIndicator.vue**: 设备状态指示器
  - 硬件/固件版本
  - 设备名称
  - 心跳状态
  - 连接状态

- **LoopManager.vue**: 循环模式管理器
  - 添加/删除时序指令
  - 开始/暂停/继续/停止
  - 执行进度显示
  - 循环次数统计

- **LogViewer.vue**: 实时通信日志（v1.3 新增）
  - 发送命令日志
  - 接收数据日志
  - 错误信息提示
  - 十六进制显示
  - 自动滚动
  - 清空日志功能

- **EmergencyStop.vue**: 紧急停止按钮
  - 一键停止所有泵
  - 确认对话框
  - 最高优先级

#### 页面2: 固件升级组件（v1.4 新增）
- **FirmwareUpdatePage.vue**: 固件升级页面容器
  - 固件信息展示
  - 串口选择
  - 固件上传控制
  - 进度显示
  - 日志输出

- **FirmwareInfoCard.vue**: 固件信息卡片
  - 固件版本号
  - 发布日期
  - 文件大小
  - 固件说明

- **FirmwareUploader.vue**: 固件上传控制器
  - 上传按钮
  - 取消按钮
  - 进度条
  - 统计信息（时间、速度）
  - 日志显示区域

---

### 页面2: 固件升级（v1.4 新增）

#### 界面布局
```
┌─────────────────────────────────────────────────────────────────────┐
│  💾 Arduino 固件升级                                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  步骤1: 确认固件信息                                          │   │
│  │  ┌───────────────────────────────────────────────────────┐   │   │
│  │  │ 📦 固件版本: fluid V1.0                                 │   │   │
│  │  │ 📅 发布日期: 2025-01-14                                 │   │   │
│  │  │ 📏 文件大小: 128 KB                                     │   │   │
│  │  │ 📝 文件名称: fluid_v1.ino.hex                           │   │   │
│  │  │                                                         │   │   │
│  │  │ ℹ️  说明: 液动控制系统官方固件，包含循环模式、心跳保活   │   │   │
│  │  │         等功能。                                         │   │   │
│  │  └───────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  步骤2: 选择串口                                              │   │
│  │  ┌───────────────────────────────────────────────────────┐   │   │
│  │  │ 🔌 当前串口: COM3 (CH340)                               │   │   │
│  │  │ 波特率: 115200                                          │   │   │
│  │  │ [重新选择串口]                                           │   │   │
│  │  └───────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  步骤3: 上传固件                                              │   │
│  │  ┌───────────────────────────────────────────────────────┐   │   │
│  │  │  [开始上传]  [取消]                                     │   │   │
│  │  │                                                         │   │   │
│  │  │  上传进度: 45% (58KB / 128KB)                           │   │   │
│  │  │  ━━━━━━━━━━━━━━━━●━━━━━━━━━━━━━━                       │   │   │
│  │  │  ⏱️ 已用时间: 00:15  ⏳ 剩余: 00:18  🚀 速度: 3.8 KB/s   │   │   │
│  │  │                                                         │   │   │
│  │  │  📋 日志输出:                                           │   │   │
│  │  │  ┌─────────────────────────────────────────┐           │   │   │
│  │  │  │ [14:30:25] 正在加载固件文件...           │           │   │   │
│  │  │  │ [14:30:25] 固件文件已加载 (128KB)        │           │   │   │
│  │  │  │ [14:30:26] 正在连接串口...               │           │   │   │
│  │  │  │ [14:30:26] 串口已连接                    │           │   │   │
│  │  │  │ [14:30:27] 正在进入引导加载模式...       │           │   │   │
│  │  │  │ [14:30:27] 引导加载程序就绪             │           │   │   │
│  │  │  │ [14:30:27] 正在发送固件数据...           │           │   │   │
│  │  │  │ [14:30:28] 数据传输中... 45%            │           │   │   │
│  │  │  │ [14:30:30] 固件上传完成！               │           │   │   │
│  │  │  └─────────────────────────────────────────┘           │   │   │
│  │  └───────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  💡 使用提示                                                 │   │
│  │  • 确保 Arduino 已通过 USB 连接到电脑                         │   │
│  │  • 上传过程中请勿断开连接或关闭页面                            │   │
│  │  • 上传会自动进入引导加载模式                                  │   │
│  │  • 如果上传失败，请尝试重新插拔 USB 线                        │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

#### 固件升级特性
- ✅ **三步骤流程**：确认信息 → 选择串口 → 上传固件
- ✅ **内置固件**：固件文件预置在项目中，用户无需选择
- ✅ **实时进度**：上传进度条、时间统计、速度显示
- ✅ **详细日志**：完整的操作日志输出，包括十六进制数据
- ✅ **状态管理**：上传状态、进度跟踪
- ✅ **错误处理**：异常捕获和友好提示
- ✅ **持续同步策略**（v1.5）：自动持续发送同步命令，用户只需在看到"正在同步..."时按复位按钮即可
- ✅ **智能数据识别**：自动区分 Bootloader 响应和用户程序输出

#### 固件文件管理
- **路径**: `public/firmware/fluid_v1.hex`
- **配置**: `src/config/firmware.js`
- **大小**: 建议 < 1MB（快速加载）
- **格式**: Intel HEX (.hex)

#### 使用流程（v1.5 持续同步策略）
1. **准备阶段**
   - 确保 Arduino 通过 USB 连接到电脑
   - 打开"固件升级"选项卡
   - 选择串口并点击"连接并继续"

2. **开始上传**
   - 确认固件信息
   - 点击"开始上传"按钮
   - 看到提示后点击"确定"

3. **按复位按钮**
   - 在看到日志显示"正在同步..."时
   - 立即按 Arduino 复位按钮（红色 RESET 按钮）
   - 系统会自动捕获 Bootloader
   - **无需精确计时**，任意时刻按都可以

4. **观察日志**
   - 系统会持续发送同步命令（每 50ms 一次）
   - 当收到 `[0x14, 0x10]` 时表示同步成功
   - 继续执行固件上传流程

#### 技术实现细节
- **STK500v1 协议**: 实现完整的 STK500v1 协议栈
- **持续同步**: 每 50ms 发送一次 `STK_GET_SYNC (0x30) + CRC_EOP (0x20)` 命令
- **智能响应检测**: 自动识别 Bootloader 响应 `[0x14, 0x10]` vs 用户程序 ASCII 输出
- **分页编程**: 128 字节/页，支持 ATmega328P
- **CRC 校验**: 所有命令和响应都经过 CRC_EOP 校验
- **Intel HEX 解析**: 纯浏览器实现，支持所有记录类型

详细技术说明请参考：`docs/CONTINUOUS_SYNC_STRATEGY.md`

---

### 页面1: 设备控制（v1.3 三栏布局）

## 🔧 核心模块实现

### 1. 串口管理器 (serialManager.js)
```javascript
export class SerialManager {
  async connect() {
    // 请求串口权限
    this.port = await navigator.serial.requestPort()
    // 打开串口（115200波特率）
    await this.port.open({ baudRate: 115200 })
    // 创建读写流
    this.reader = this.port.readable.getReader()
    this.writer = this.port.writable.getWriter()
    // 启动接收循环
    this.receiveLoop()
  }

  async sendFrame(cmd, data = []) {
    const frame = this.buildFrame(cmd, data)
    await this.writer.write(frame)
  }

  async receiveLoop() {
    while (true) {
      const { value, done } = await this.reader.read()
      if (done) break
      this.parseResponse(value)
    }
  }
}
```

### 2. 协议封装器 (protocol.js)
```javascript
export function buildFrame(cmd, data) {
  const frame = [
    0xAA, 0x55,              // 帧头
    cmd,                     // 命令
    data.length,             // 长度
    ...data,                 // 数据
  ]
  const crc = calcCRC8(frame.slice(2)) // 计算CRC
  frame.push(crc)
  return new Uint8Array(frame)
}

export function parseResponse(buffer) {
  // 检查帧头
  if (buffer[0] !== 0xAA || buffer[1] !== 0x55) return
  // 提取命令和长度
  const cmd = buffer[2]
  const len = buffer[3]
  const data = buffer.slice(4, 4 + len)
  const crcRecv = buffer[4 + len]
  // 校验CRC
  const crcCalc = calcCRC8(buffer.slice(2, 4 + len))
  if (crcRecv !== crcCalc) throw new Error('CRC校验失败')
  return { cmd, data }
}
```

### 3. 心跳保活 (useHeartbeat.js)
```javascript
export function useHeartbeat(serialManager) {
  const sequence = ref(0)
  const enabled = ref(true)
  let interval = null

  function start() {
    interval = setInterval(() => {
      sendHeartbeat()
      sequence.value = (sequence.value + 1) % 256
    }, 1000) // 每1秒发送
  }

  function sendHeartbeat() {
    const data = [sequence.value, enabled.value ? 1 : 0]
    serialManager.sendFrame(0x50, data)
  }

  function onTimeout() {
    console.error('心跳超时，设备已断开')
    // 自动停止所有泵
    serialManager.sendFrame(0x12, [])
  }

  return { start, stop, sendHeartbeat }
}
```

### 4. Pinia Store (device.js)
```javascript
import { defineStore } from 'pinia'

export const useDeviceStore = defineStore('device', {
  state: () => ({
    // 设备信息
    hardwareVersion: '1.0',
    firmwareVersion: '1.0',
    name: 'fluid V0',

    // 通道状态
    channels: {
      ch1: {
        activePump: 0,      // 0=无, 1=气泵, 2=液泵1, 3=液泵2
        isRunning: false,
        pwm: 0
      },
      ch2: {
        activePump: 0,
        isRunning: false,
        pwm: 0
      }
    },

    // 循环模式状态
    loop: {
      isRunning: false,
      isPaused: false,
      currentIndex: 0,
      totalSteps: 0,
      loopCount: 0,
      sequence: []
    }
  }),

  actions: {
    updateChannel(channel, data) {
      this.channels[channel] = { ...this.channels[channel], ...data }
    },

    updateLoopStatus(status) {
      this.loop = { ...this.loop, ...status }
    }
  }
})
```

---

## 🚀 开发指南

### 环境要求
- Node.js >= 18.0.0
- Chrome/Edge 浏览器（支持 Web Serial API）
- Arduino 开发板（已烧录下位机代码）

### 快速开始
```bash
# 1. 安装依赖
npm install

# 2. 启动开发服务器
npm run dev

# 3. 打开浏览器访问
# http://localhost:5173

# 4. 连接串口并测试
```

### 浏览器兼容性
Web Serial API 目前仅在基于 Chromium 的浏览器中可用：
- ✅ Chrome 89+
- ✅ Edge 89+
- ✅ Opera 75+
- ❌ Firefox（暂不支持）
- ❌ Safari（暂不支持）

### HTTPS 要求
Web Serial API 只能在安全上下文中使用：
- 本地开发：`http://localhost` 或 `http://127.0.0.1`
- 生产环境：必须使用 `https://`

---

## 🔐 安全机制

### 1. 心跳保活
- **发送频率**: 每 1 秒
- **超时时间**: 3 秒无响应自动停机
- **使能控制**: 可关闭超时检测（调试用）

### 2. CRC8 校验
- 所有数据帧必须通过 CRC8 校验
- 校验失败自动丢弃并记录错误

### 3. 错误处理
- **0x01**: CRC 校验错误
- **0x02**: 命令不支持
- **0x03**: 参数错误
- **0x04**: 通道号错误
- **0x05**: 泵类型错误
- **0x06**: 硬件故障
- **0x07**: 时序表已满
- **0x08**: 模式冲突
- **0x09**: 泵冲突

### 4. 紧急停止
- 最高优先级命令（0x12）
- 响应时间 < 10ms
- 立即停止所有泵

---

## 📖 相关文档

- **功能需求**: `功能需求.md` - 系统功能需求说明
- **通讯协议**: `液动通讯协议.md` - 详细的协议定义和示例
- **下位机代码**: `reference/yedong/` - Arduino 下位机实现

---

## 🛠️ 开发规范

### 代码风格
- 使用 ESLint + Prettier
- 组件命名：PascalCase
- 文件命名：kebab-case
- 组合式函数：use 前缀

### Git 提交规范
```
feat: 新功能
fix: 修复bug
docs: 文档更新
style: 代码格式调整
refactor: 重构
test: 测试相关
chore: 构建/工具变更
```

### 测试建议
1. **单元测试**: CRC8 算法、协议封装
2. **集成测试**: 串口通信、命令响应
3. **端到端测试**: 完整功能流程测试

---

## 📝 项目状态

### ✅ 已完成功能（v1.3）

#### 第一阶段 - 核心功能 ✅
- ✅ 项目初始化（Vue3 + Vite）
- ✅ Web Serial API 串口连接
- ✅ 协议帧封装和解析
- ✅ CRC8 校验实现
- ✅ 心跳保活机制
- ✅ 基础泵控制界面
- ✅ 三栏布局设计
- ✅ 横向泵控制布局

#### 第二阶段 - 完整功能 ✅
- ✅ 循环模式实现
- ✅ 状态实时监控（每秒轮询）
- ✅ 错误处理和提示
- ✅ 界面优化和响应式设计
- ✅ 实时通信日志系统
- ✅ 初始化信息过滤机制

#### 第三阶段 - 优化提升 ✅
- ✅ 操作日志记录
- ✅ 断开连接错误修复
- ✅ 版本信息获取优化
- ✅ 用户体验优化
- ✅ 双PWM条显示（设置PWM + 实际PWM）

#### 第四阶段 - 功能扩展 ✅ (v1.4)
- ✅ 多页面设计（选项卡切换）
- ✅ 固件升级功能
- ✅ 循环状态查询
- ✅ 固件内置管理

### 🎯 版本历史

#### v1.0（初始版本）
- 基础串口通信
- 简单泵控制界面
- 单列布局

#### v1.1（三栏布局）
- 三栏布局设计
- 实时通信日志
- 自动状态刷新（1秒轮询）
- 版本信息只获取一次

#### v1.2（横向布局）
- 通道控制横向排列
- 版本信息获取修复（延时+清缓存）
- 界面优化

#### v1.3（当前版本）
- **新增**: 完善初始化信息过滤
- **新增**: 强力清空缓存功能（3秒等待+持续读取）
- **新增**: 延迟启动接收循环
- **新增**: 双PWM条显示（设置+实际）
- **优化**: 版本信息100%获取成功
- **优化**: 连接稳定性大幅提升

#### v1.4（已发布）
- **新增**: 多页面设计（设备控制 + 固件升级）
- **新增**: 固件升级功能
- **新增**: 固件内置管理（无需用户选择）
- **新增**: 循环状态查询机制
- **新增**: 固件上传进度显示
- **优化**: 页面切换体验
- **优化**: 循环状态实时更新

#### v1.5（已发布 - 固件上传成功）
- **新增**: 基于 avrgirl-arduino 的固件上传功能
- **新增**: 使用 avrgirl-arduino.global.js（浏览器版本）
- **新增**: 完整的固件上传界面和进度显示
- **新增**: 实时日志输出和错误处理
- **文档**: 详细实现指南和快速移植指南
- **状态**: ✅ 已验证成功

#### v1.4（开发中 - 持续同步策略）
- **新增**: 持续同步策略（"守株待兔"）
  - 移除阻塞等待，持续发送 STK_GET_SYNC 命令
  - 每 50ms 发送一次，共 50 次尝试（2.5 秒窗口期）
  - 用户可在任意时刻按复位按钮，无需精确计时
- **新增**: 智能数据识别
  - 自动区分 Bootloader 响应 `[0x14, 0x10]`
  - 自动识别用户程序 ASCII 输出
- **优化**: 简化用户操作流程
  - 移除复杂的倒计时逻辑
  - 清晰的日志提示
- **优化**: 提高同步成功率
  - 从 ~30% 提升到预计 >90%
  - 更长的有效窗口期（2.5 秒 vs 1 秒）

---

## 📚 相关文档

| 文档 | 说明 |
|-----|------|
| `CLAUDE.md` | 项目架构文档（本文档） |
| `README.md` | 项目说明和使用指南 |
| `TEST.md` | 测试文档 |
| **`FIRMWARE_UPLOAD_SUCCESS_GUIDE.md`** | **v1.5 固件上传完整实现指南（详细）** |
| **`QUICK_START_FIRMWARE_UPLOAD.md`** | **v1.5 固件上传快速移植指南（简化）** |
| `CONTINUOUS_SYNC_STRATEGY.md` | v1.5 持续同步策略详细说明（已废弃） |
| `UPDATE_v1.4.md` | v1.4 更新说明（多页面+固件升级） |
| `UPDATE_v1.3.md` | v1.3 更新说明（初始化过滤） |
| `UPDATE_v1.2.md` | v1.2 更新说明（横向布局） |
| `UPDATE_v1.1.md` | v1.1 更新说明（三栏布局） |
| `FIX_DISCONNECT.md` | 断开串口错误修复 |
| `FIXES.md` | 常见问题快速修复 |
| `液动通讯协议.md` | 详细的协议定义和示例 |
| `功能需求.md` | 系统功能需求说明 |
| `reference/yedong/` | Arduino 下位机代码 |

---

## 🛠️ 开发规范

---

## 📞 技术支持

### 常见问题

#### 连接相关

**Q: Web Serial API 不工作？**
A:
1. 确保使用 Chrome/Edge 浏览器（支持 Web Serial API）
2. 确保通过 `https://` 或 `http://localhost` 访问
3. 更新浏览器到最新版本

**Q: 串口连接失败？**
A:
1. 检查 Arduino 是否正确连接
2. 确认端口未被其他程序占用（如 Arduino IDE 串口监视器）
3. 尝试重新插拔 USB 线
4. 检查浏览器是否有串口访问权限

**Q: 连接需要等待较长时间？**
A: 正常现象。系统会：
1. 等待 3 秒（设备初始化）
2. 清空缓存（过滤初始化调试信息）
3. 启动接收循环
4. 获取版本信息
总耗时约 4 秒，这是正常的。

**Q: 版本信息获取失败？**
A:
1. 确认模式开关在 ONLINE 位置（高电平）
2. 检查日志窗口，应该能看到"清空初始化信息"的日志
3. 如果没有初始化信息，可能固件版本不同
4. 尝试断开重连

#### 使用相关

**Q: 心跳超时？**
A:
1. 检查串口通信是否正常
2. 确认下位机代码已正确烧录
3. 查看日志窗口是否有心跳发送/接收记录

**Q: 泵不工作？**
A:
1. 确认模式开关在 ONLINE 位置（高电平）
2. 检查 PWM 值是否在 0-255 范围内
3. 查看日志窗口确认命令已发送
4. 使用 Arduino IDE 串口监视器查看下位机状态

**Q: 如何查看通信日志？**
A:
1. 连接成功后，右侧日志窗口会自动显示
2. 蓝色：发送的命令
3. 绿色：接收的数据
4. 红色：错误信息
5. 点击"清空"按钮可以清空日志

**Q: 断开串口时报错？**
A: 已在 v1.3 修复。如果还有问题：
1. 确保使用最新版本
2. 查看浏览器控制台错误信息
3. 检查日志窗口的详细错误

#### 界面相关

**Q: 如何查看通道的实时状态？**
A: 系统每秒自动查询一次状态，泵的运行状态会实时更新。

**Q: 通道控制为什么是横向的？**
A: v1.2 版本改为横向布局，更紧凑，便于对比三个泵的状态。

**Q: 如何使用循环模式？**
A:
1. 在中间栏点击"添加"按钮
2. 填写时序指令（通道、泵类型、PWM、时间）
3. 点击"开始"执行循环
4. 可以暂停/继续/停止循环

---

## 🔐 安全机制

### 心跳保活
- **发送频率**: 每 1 秒
- **超时时间**: 3 秒无响应自动停机
- **使能控制**: 可关闭超时检测（调试用）

### CRC8 校验
- 所有数据帧必须通过 CRC8 校验
- 校验失败自动丢弃并记录错误

### 错误处理
- **0x01**: CRC 校验错误
- **0x02**: 命令不支持
- **0x03**: 参数错误
- **0x04**: 通道号错误
- **0x05**: 泵类型错误
- **0x06**: 硬件故障
- **0x07**: 时序表已满
- **0x08**: 模式冲突
- **0x09**: 泵冲突

### 紧急停止
- 最高优先级命令（0x12）
- 响应时间 < 10ms
- 立即停止所有泵

---

## 📂 项目文件结构

### 完整目录树
```
fliud_v0_web/
├── public/                          # 静态资源目录
│   └── firmware/                   # 固件文件 (v1.4)
│       └── fluid_v1.hex           # Arduino固件文件
│
├── src/                            # 源代码目录
│   ├── assets/                     # 资源文件
│   ├── components/                 # Vue组件
│   │   ├── ChannelPanel.vue       # 通道面板容器
│   │   ├── PumpControl.vue        # 泵控制卡片
│   │   ├── LoopManager.vue        # 循环模式管理器
│   │   ├── LogViewer.vue          # 通信日志查看器
│   │   ├── EmergencyStop.vue      # 紧急停止按钮
│   │   ├── DeviceControlPage.vue  # 设备控制页面 (v1.4)
│   │   ├── FirmwareUpdatePage.vue # 固件升级页面 (v1.4)
│   │   └── ...
│   │
│   ├── composables/                # 组合式函数
│   │   ├── useSerial.js            # 串口通信逻辑
│   │   └── useLoopControl.js      # 循环控制逻辑
│   │
│   ├── config/                     # 配置文件 (v1.4)
│   │   └── firmware.js            # 固件配置
│   │
│   ├── stores/                     # Pinia状态管理
│   │   ├── connection.js          # 连接状态
│   │   ├── device.js              # 设备状态
│   │   ├── loop.js                # 循环状态
│   │   └── log.js                 # 日志状态
│   │
│   ├── utils/                      # 工具函数
│   │   ├── serialManager.js       # 串口管理器
│   │   ├── protocol.js            # 协议处理
│   │   └── crc8.js               # CRC8校验
│   │
│   ├── App.vue                     # 根组件
│   └── main.js                     # 应用入口
│
├── reference/                      # 参考代码
│   └── yedong/                     # Arduino下位机代码
│       └── yedong.ino             # 固件源代码
│
├── docs/                           # 文档目录
│   ├── CONTINUOUS_SYNC_STRATEGY.md # v1.5 持续同步策略
│   ├── UPDATE_v1.4.md             # v1.4更新说明
│   ├── UPDATE_v1.3.md             # v1.3更新说明
│   ├── UPDATE_v1.2.md             # v1.2更新说明
│   ├── FIX_DISCONNECT.md          # 断开连接修复
│   └── ...
│
├── CLAUDE.md                       # 项目架构文档（本文档）
├── README.md                       # 项目说明
├── TEST.md                         # 测试文档
├── 液动通讯协议.md                 # 通讯协议文档
├── 功能需求.md                     # 功能需求文档
├── package.json                    # 项目配置
└── vite.config.js                  # Vite配置
```

### 新增文件说明（v1.4）

#### 配置文件
- **src/config/firmware.js**: 固件元信息和路径配置
  ```javascript
  export const FIRMWARE_INFO = {
    name: 'fluid V1.0',
    version: '1.0.0',
    date: '2025-01-14',
    fileName: 'fluid_v1.ino.hex',
    fileSize: 128 * 1024,
    description: '液动控制系统官方固件',
    filePath: '/firmware/fluid_v1.hex'
  }
  ```

#### 新增组件
- **DeviceControlPage.vue**: 设备控制页面容器
  - 整合现有的所有设备控制组件
  - 作为选项卡面板1的内容

- **FirmwareUpdatePage.vue**: 固件升级页面（完整实现）
  - 固件信息展示卡片
  - 串口选择区域
  - 固件上传控制器
  - 进度显示和日志输出

#### 固件文件
- **public/firmware/fluid_v1.hex**: Arduino固件二进制文件
  - 通过 fetch API 加载
  - 不参与打包，减少 JS 体积
  - 可独立更新

---

## 📄 许可证

本项目为内部项目，版权归项目组所有。

---

**版本**: 1.0
**更新日期**: 2025-01-14
**协议版本**: PWM 直接控制（0-255）
**维护者**: 液动工具包项目组
