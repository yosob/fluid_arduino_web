# Device Control Page 详细设计文档

**版本**: v1.6
**更新日期**: 2025-01-15
**页面名称**: 设备控制页面
**文件路径**: `src/components/pages/DeviceControlPage.vue`

---

## 📋 页面概述

### 功能定位

设备控制页面是系统的核心功能页面，提供：
- ✅ 串口连接管理
- ✅ 设备状态监控
- ✅ 双通道手动控制（指令模式）
- ✅ 双通道循环编程（循环模式）
- ✅ 实时通信日志
- ✅ 紧急停止控制

### 页面布局

```
┌─────────────────────────────────────────────────────────────┐
│  液动控制系统 v1.5                         [🔌连接串口]     │
├──────────────────┬──────────────────┬─────────────────────┤
│  左侧栏 (33%)    │  中间栏 (33%)    │  右侧栏 (33%)      │
│  ┌────────────┐  │  ┌────────────┐  │  ┌───────────────┐│
│  │📊 设备状态 │  │  │ 🔄 循环模式│  │  │ 📜 通信日志   ││
│  │            │  │  │            │  │  │               ││
│  │ 硬件版本   │  │  │[▶开始执行] │  │  │ 实时日志      ││
│  │ 固件版本   │  │  │[⏸暂停]    │  │  │               ││
│  │ 设备名称   │  │  │[▶继续]     │  │  │ 十六进制显示  ││
│  │ 心跳状态   │  │  │[⏹停止]     │  │  │               ││
│  └────────────┘  │  │[🗑清空所有]│  │  │ 自动滚动      ││
│                  │  │循环次数[0] │  │  └───────────────┘│
│  📍 通道 1       │  │(0=无限循环)│  │                     │
│  ┌─────────┐    │  ├────────────┤  │                     │
│  │ 💨💧💧  │    │  │📍CH1 [添加]│  │                     │
│  │气泵 液1 液2│  │  │┌序┌泵┌PWM┌时│  │                     │
│  └─────────┘    │  │  │1│气│150│2s│  │                     │
│                  │  │  │2│液│200│3s│  │                     │
│  📍 通道 2       │  │  └┬┴┬┴┬┴┬┴┬┘  │                     │
│  ┌─────────┐    │  │状态:运行中 ✓│  │                     │
│  │ 💨💧💧  │    │  │进度:2/5     │  │                     │
│  │气泵 液1 液2│  │  │循环:3/∞     │  │                     │
│  └─────────┘    │  ├────────────┤  │                     │
│                  │  │📍CH2 [添加]│  │                     │
│  🛑 紧急停止     │  │...         │  │                     │
└──────────────────┴──────────────────┴─────────────────────┘
```

### 中间栏详细展开（循环模式）

```
┌─────────────────────────────────────────────────────────────────────┐
│  🔄 循环模式 - 双通道独立编程                                        │
├─────────────────────────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────────────────────────────┐│
│  │  统一控制区域                                                   ││
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐          ││
│  │  │ ▶ 开始执行│ │ ⏸ 暂停   │ │ ▶ 继续   │ │ ⏹ 停止   │          ││
│  │  │  (绿色)  │ │  (黄色)  │ │  (蓝色)  │ │  (红色)  │          ││
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘          ││
│  │  ┌──────────┐                                                 ││
│  │  │ 🗑 清空所有│                                                 ││
│  │  └──────────┘                                                 ││
│  │                                                                 ││
│  │  循环次数: [      0    ] (0 = 无限循环)                        ││
│  └────────────────────────────────────────────────────────────────┘│
├─────────────────────────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────────────────────────────┐│
│  │  📍 通道 1 (CH1)                           [➕ 添加指令]      ││
│  ├────────────────────────────────────────────────────────────────┤│
│  │  ┌──────┬─────────┬─────┬──────────┬──────────┐              ││
│  │  │ 序号 │  泵     │ PWM │ 时间(ms) │  操作    │              ││
│  │  ├──────┼─────────┼─────┼──────────┼──────────┤              ││
│  │  │  1   │ 气泵 💨 │ 150 │   2000   │  [🗑删除]│              ││
│  │  │  2   │ 液泵1 💧 │ 200 │   3000   │  [🗑删除]│              ││
│  │  └──────┴─────────┴─────┴──────────┴──────────┘              ││
│  │                                                                 ││
│  │  ┌─────────────────────────────────────────────────────────┐  ││
│  │  │ 状态: [运行中 ✓]  进度: [2 / 5]  循环: [3 / ∞]         │  ││
│  │  └─────────────────────────────────────────────────────────┘  ││
│  └────────────────────────────────────────────────────────────────┘│
│                                                                     │
│  ┌────────────────────────────────────────────────────────────────┐│
│  │  📍 通道 2 (CH2)                           [➕ 添加指令]      ││
│  │  [相同的结构...]                                               ││
│  └────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────┘
```

**按钮说明**:
- **▶ 开始执行** (绿色): 启动双通道并行循环，需要至少有一条指令
- **⏸ 暂停** (黄色): 暂停双通道执行，仅在运行时可用
- **▶ 继续** (蓝色): 恢复双通道执行，仅在暂停时可用
- **⏹ 停止** (红色): 停止双通道执行并清空状态
- **🗑 清空所有**: 清空两个通道的所有时序指令
- **➕ 添加指令**: 分别为每个通道添加新的循环指令（CH1和CH2独立）
- **🗑删除**: 删除表格中单条指令

---

## 🔌 1. 串口选择器 (SerialPortSelector)

### 位置
- **文件**: `src/components/device/SerialPortSelector.vue`
- **页面位置**: 顶部右侧

### 功能
管理Web Serial API串口连接

### 按钮详解

#### 🔗 连接串口按钮

**显示条件**: 未连接时显示

**点击动作**:
```
1. 调用 browser.serial.requestPort()
   ↓
2. 用户在系统对话框中选择串口
   ↓
3. 打开串口 (baudRate: 115200)
   ↓
4. 启动接收循环
   ↓
5. 获取设备版本信息
   ↓
6. 启动状态轮询 (1秒/次)
   ↓
7. 更新连接状态为已连接
```

**发送的命令**:
```
连接后自动发送:
[0xAA][0x55][0x20][0x00][CRC8]  - GET_VERSION (获取版本)
[0xAA][0x55][0x21][0x00][CRC8]  - GET_STATUS (获取状态)
```

**响应**:
```
VERSION_RSP (0x30):
  - 硬件版本
  - 固件版本
  - 设备名称

STATUS_RSP (0x31):
  - 工作模式 (0=指令, 1=循环)
  - CH1状态
  - CH2状态
```

---

#### ❌ 断开连接按钮

**显示条件**: 已连接时显示

**点击动作**:
```
1. 关闭串口连接
   ↓
2. 停止状态轮询
   ↓
3. 重置设备状态
   ↓
4. 更新连接状态为未连接
```

**发送的命令**: 无

---

## 📊 2. 设备状态指示器 (StatusIndicator)

### 位置
- **文件**: `src/components/device/StatusIndicator.vue`
- **页面位置**: 左侧栏顶部

### 显示内容

```
┌─────────────────────┐
│ 📊 设备状态           │
├─────────────────────┤
│ 硬件版本: v1.0       │
│ 固件版本: fluid V1.0  │
│ 设备名称: FluidCtrl  │
│ 连接状态: 已连接 ✓    │
│ 工作模式: 🎮 指令模式  │
│ 心跳状态: ● 正常     │
└─────────────────────┘
```

### 状态项详解

#### 1. 硬件/固件版本

**数据来源**: GET_VERSION (0x20) 命令响应（连接时获取一次）

```
VERSION_RSP (0x30):
  - 硬件版本 (如 v1.0)
  - 固件版本 (如 fluid V1.0)
  - 设备名称 (如 FluidCtrl)
```

#### 2. 连接状态

**显示方式**: Tag 标签

| 状态 | 颜色 | 图标 | 说明 |
|:----:|:----:|:----:|:-----|
| 已连接 | 绿色 (success) | ✓ | 串口已打开 |
| 未连接 | 红色 (danger) | ✗ | 串口未打开 |

#### 3. 工作模式 ⭐ v1.6新增

**数据来源**: GET_STATUS (0x21) 命令响应（每秒轮询）

**显示方式**: Tag 标签 + 图标

| 模式 | 图标 | 文本 | 颜色 | 值 | 说明 |
|:----:|:----:|:-----|:----:|:--:|:-----|
| **MANUAL** | 🎮 | 指令模式 | 蓝色 (primary) | 0 | 手动控制泵，默认模式 |
| **LOOP** | 🔄 | 循环模式 | 绿色 (success) | 1 | 自动执行时序表 |
| **STOP** | ⏸ | 停止模式 | 橙色 (warning) | 2 | 系统停止状态 |

**自动切换机制** (Protocol v1.3):

```
MANUAL → LOOP:
  发送 LOOP_START 命令
  ↓
  系统自动切换到 LOOP 模式
  ↓
  UI 显示: 🔄 循环模式 (绿色)

LOOP → MANUAL:
  发送 LOOP_STOP 命令
  ↓
  系统自动切换回 MANUAL 模式
  ↓
  UI 显示: 🎮 指令模式 (蓝色)
```

**未连接状态**:
```
连接状态: 未连接 (红色)
工作模式: 未连接 (灰色)
心跳状态: 未连接 (灰色)
```

#### 4. 心跳状态

**心跳机制**:
- 每1秒发送一次心跳包
- 超过3秒无响应 → 心跳超时警告
- 心跳正常时显示绿色圆点
- 心跳超时时显示红色圆点

**显示方式**: Tag 标签

| 状态 | 颜色 | 图标 | 说明 |
|:----:|:----:|:----:|:-----|
| 正常 | 绿色 (success) | ✓ | 心跳检测开启，响应正常 |
| 已关闭 | 橙色 (warning) | ⚠ | 心跳检测关闭 |
| 超时 | 红色 (danger) | ✗ | 超过3秒无响应 |
| 未连接 | 灰色 (info) | - | 设备未连接 |

### 更新机制

**自动更新**: 每秒自动刷新

**更新流程**:
```
1. useSerial 发送 GET_STATUS 命令 (0x21)
   ↓
2. 接收 STATUS_RSP (0x31)
   ↓
3. 解析响应数据
   data[0] = workMode (0/1/2)
   data[1:] = 通道状态数据
   ↓
4. 更新 deviceStore.updateWorkMode(mode)
   ↓
5. UI 自动响应式更新
```

**工作模式数据流**:
```
串口响应 (STATUS_RSP)
  ↓
useSerial.handleResponse()
  ↓
deviceStore.updateWorkMode(mode)
  ↓
StatusIndicator (自动响应式更新)
  ↓
显示: 🎮 指令模式 / 🔄 循环模式 / ⏸ 停止模式
```

---

## 📍 3. 通道面板 (ChannelPanel)

### 位置
- **文件**: `src/components/device/ChannelPanel.vue`
- **页面位置**: 左侧栏中部（两个面板，CH1和CH2）

### 功能
显示单个通道的三个泵控制卡片

### 组件结构

```
┌────────────────────────────────────────┐
│ 📍 通道 1                    [运行中 ✓] │
├────────────────────────────────────────┤
│ ┌────────┐  ┌────────┐  ┌────────┐   │
│ │ 💨气泵 │  │ 💧液泵1│  │ 💧液泵2│   │
│ │已停止  │  │运行中 ✓│  │已停止  │   │
│ │        │  │        │  │        │   │
│ │设置PWM │  │设置PWM │  │设置PWM │   │
│ │当前PWM │  │当前PWM │  │当前PWM │   │
│ └────────┘  └────────┘  └────────┘   │
└────────────────────────────────────────┘
```

---

## ⚙️ 4. 泵控制卡片 (PumpControl)

### 位置
- **文件**: `src/components/device/PumpControl.vue`
- **页面位置**: 通道面板内（每个通道3个）

### 功能详解

每个泵控制卡片包含：
- 泵图标和名称
- 运行状态标签
- 设置PWM滑块（可交互）
- 当前PWM滑块（只读，显示实际值）

### 交互方式

#### 方式1: 点击整个卡片（启动/停止）

**点击动作**:
```
如果当前已运行 → 停止泵
  ↓
  发送 STOP_CHANNEL 命令

如果当前未运行 → 启动泵
  ↓
  发送 SET_PUMP 命令（使用设置PWM的值）
```

#### 方式2: 拖动PWM滑块（调节功率）

**拖动动作**:
```
拖动"设置PWM"滑块
  ↓
实时更新本地配置
  ↓
如果当前正在运行
  ↓
立即发送新的 SET_PUMP 命令
```

### 发送的命令

#### 启动泵 (SET_PUMP 0x10)

**点击卡片启动时发送**:

```
命令格式: [0xAA][0x55][0x10][0x03][CH][PUMP][PWM][CRC8]

参数说明:
  CH    - 通道号 (1=CH1, 2=CH2)
  PUMP  - 泵类型 (0=气泵, 1=液泵1, 2=液泵2)
  PWM  - PWM值 (0-255)

示例:
  启动 CH1 气泵 PWM=150:
  [0xAA][0x55][0x10][0x03][0x01][0x00][0x96][CRC8]
```

**响应**:
```
ACK (0x40) - 成功
NACK (0x41) + ERROR_CODE - 失败
  - 0x04: 通道号错误
  - 0x05: 泵类型错误
  - 0x08: 模式冲突（循环模式）
  - 0x09: 泵冲突
```

#### 停止泵 (STOP_CHANNEL 0x11)

**点击卡片停止时发送**:

```
命令格式: [0xAA][0x55][0x11][0x01][CH][CRC8]

参数说明:
  CH - 通道号 (1=CH1, 2=CH2)

示例:
  停止 CH1:
  [0xAA][0x55][0x11][0x01][0x01][CRC8]
```

**响应**:
```
ACK (0x40) - 成功
NACK (0x41) + ERROR_CODE - 失败
  - 0x04: 通道号错误
```

### PWM滑块详解

#### 设置PWM滑块（可拖动）

**功能**: 设置目标PWM值

**范围**: 0-255

**交互**:
- 拖动滑块实时更新显示值
- 松开滑块触发 `@change` 事件
- 如果泵正在运行，立即发送新PWM值

**更新流程**:
```
1. 用户拖动滑块
   ↓
2. 更新本地配置 (deviceStore.pumpConfigs)
   ↓
3. 如果正在运行
   ↓
4. 发送 SET_PUMP 命令（新PWM值）
   ↓
5. 等待 ACK 确认
```

#### 当前PWM滑块（只读）

**功能**: 显示设备实际输出的PWM值

**更新源**: 从STATUS_RSP (0x31)响应中获取

**更新频率**: 每秒自动刷新

**显示逻辑**:
```
STATUS_RSP 解析:
  channels.ch1.actualPwm.air    → CH1 气泵当前PWM
  channels.ch1.actualPwm.water1 → CH1 液泵1当前PWM
  channels.ch1.actualPwm.water2 → CH1 液泵2当前PWM
```

### 视觉反馈

#### 未运行状态

```
┌──────────────────┐
│ 💨 气泵          │  ← 灰色边框
│ [已停止]         │  ← 蓝色标签
│                  │
│ 设置PWM: ━━━●━━━ │  ← 蓝色滑块
│ 当前PWM: ━━━●━━━ │  ← 灰色滑块（禁用）
└──────────────────┘
```

#### 运行中状态

```
┌──────────────────┐
│ 💨 气泵          │  ← 渐变紫色背景 + 绿色边框
│ [运行中 ✓]       │  ← 绿色标签
│                  │
│ 设置PWM: ━━━●━━━ │  ← 白色滑块
│ 当前PWM: ━━━●━━━ │  ← 绿色滑块（禁用）
└──────────────────┘
```

---

## 🔄 5. 循环模式管理器 (LoopManager) - v1.6双通道UI

### 位置
- **文件**: `src/components/device/LoopManager.vue`
- **页面位置**: 中间栏（上下排列）

### 功能详解

#### 整体布局

```
┌────────────────────────────────────────────────────────────────┐
│  🔄 循环模式 - 双通道独立编程                                    │
├────────────────────────────────────────────────────────────────┤
│  统一控制: [开始执行] [暂停] [继续] [停止] [清空所有]            │
│            循环次数: [0] (0 = 无限循环)                         │
├────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐  │
│  │  📍 通道 1 (CH1)        [蓝色边框]                      │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │  [添加指令]                                             │  │
│  │  ┌──────┬─────┬─────┬───┐                              │  │
│  │  │序号  │泵   │PWM  │时间│                            │  │
│  │  ├──────┼─────┼─────┼───┤                              │  │
│  │  │  1   │气泵 │150  │2s  │                            │  │
│  │  │  2   │液泵1│200  │2s  │                            │  │
│  │  └──────┴─────┴─────┴───┘                              │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │  状态: 运行中 ✓                                          │  │
│  │  进度: 2 / 5                                            │  │
│  │  循环: 3 / ∞                                             │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │  📍 通道 2 (CH2)        [绿色边框]                      │  │
│  │  [相同的结构]                                           │  │
│  └─────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────┘
```

### 按钮详解

#### ▶️ 开始执行按钮

**图标**: VideoPlay（绿色）
**位置**: 统一控制区域最左侧

**功能**: 启动双通道并行循环执行

**启用条件**:
- ✅ CH1或CH2至少有一个指令
- ✅ 当前未运行

**点击动作**:
```
1. 检查循环次数设置
   - 0 = 无限循环
   - 1-255 = 指定循环次数
   ↓
2. 发送 LOOP_ADD 命令（编程阶段）
   - 遍历 CH1 序列，逐条发送
   - 遍历 CH2 序列，逐条发送
   每条指令间隔 50ms
   ↓
3. 发送 LOOP_START 命令（执行阶段）
   ↓
4. 两个通道开始并行执行
   ↓
5. 启动状态轮询（1秒/次）
```

**发送的命令序列**:

```
阶段1: 编程阶段

清空时序表:
[0xAA][0x55][0x15][0x00][CRC8]  - LOOP_CLEAR

添加CH1指令（示例）:
[0xAA][0x55][0x14][0x05][0x01][0x00][0x96][0x00][0x32][CRC8]  - CH1 气泵 PWM=150 2s
[0xAA][0x55][0x14][0x05][0x01][0x01][0xC8][0x00][0x32][CRC8]  - CH1 液泵1 PWM=200 2s
...

添加CH2指令（示例）:
[0xAA][0x55][0x14][0x05][0x02][0x00][0x96][0x00][0x32][CRC8]  - CH2 气泵 PWM=150 2s
...

阶段2: 执行阶段

开始循环:
[0xAA][0x55][0x16][0x01][0x03][CRC8]  - LOOP_START CNT=3 (循环3次)

无限循环:
[0xAA][0x55][0x16][0x01][0x00][CRC8]  - LOOP_START CNT=0 (无限循环)
```

**响应**:
```
每个 LOOP_ADD 收到 ACK (0x40) - 成功
LOOP_START 收到 ACK (0x40) - 成功
```

---

#### ⏸️ 暂停按钮

**图标**: VideoPause（黄色）
**位置**: 统一控制区域第二个

**功能**: 暂停双通道循环执行

**启用条件**: 当前正在运行且未暂停

**点击动作**:
```
1. 发送 LOOP_PAUSE 命令
   ↓
2. 两个通道同时暂停
   ↓
3. UI 更新按钮文本为"继续"
```

**发送的命令**:
```
[0xAA][0x55][0x18][0x00][CRC8]  - LOOP_PAUSE
```

**响应**:
```
ACK (0x40) - 成功
```

---

#### ▶️ 继续按钮

**图标**: VideoPlay（蓝色）
**位置**: 统一控制区域第三个（暂停时显示）

**功能**: 恢复双通道循环执行

**启用条件**: 当前处于暂停状态

**点击动作**:
```
1. 发送 LOOP_RESUME 命令
   ↓
2. 两个通道同时从暂停点继续执行
   ↓
3. UI 更新按钮文本为"暂停"
```

**发送的命令**:
```
[0xAA][0x55][0x19][0x00][CRC8]  - LOOP_RESUME
```

**响应**:
```
ACK (0x40) - 成功
```

---

#### ⏹️ 停止按钮

**图标**: CircleClose（红色）
**位置**: 统一控制区域第四个

**功能**: 停止双通道循环执行

**启用条件**: 当前正在运行或已暂停

**点击动作**:
```
1. 发送 LOOP_STOP 命令
   ↓
2. 两个通道立即停止
   ↓
3. 清空执行状态
   ↓
4. 停止状态轮询
```

**发送的命令**:
```
[0xAA][0x55][0x17][0x00][CRC8]  - LOOP_STOP
```

**响应**:
```
ACK (0x40) - 成功
```

---

#### 🗑️ 清空所有按钮

**图标**: Delete（灰色）
**位置**: 统一控制区域第五个

**功能**: 清空双通道所有时序指令

**启用条件**: 总是可用

**点击动作**:
```
1. 弹出确认对话框
   "确定要清空所有时序指令吗？"
   ↓
2. 用户确认
   ↓
3. 清空 loopStore.sequence
   ↓
4. 发送 LOOP_CLEAR 命令
```

**发送的命令**:
```
[0xAA][0x55][0x15][0x00][CRC8]  - LOOP_CLEAR
```

**响应**:
```
ACK (0x40) - 成功
```

---

#### 循环次数设置

**类型**: 数字输入框
**范围**: 0-255
**默认值**: 0（无限循环）
**位置**: 统一控制区域右侧

**功能**: 设置循环执行的次数

**说明**:
- `0` = 无限循环（一直执行直到手动停止）
- `1-255` = 执行指定次数后自动停止

**使用时机**: 点击"开始执行"时读取此值

---

### 添加指令对话框

#### 触发方式

点击对应通道的"添加指令"按钮

**通道1对话框标题**: "添加循环指令 - 通道1 (CH1)"
**通道2对话框标题**: "添加循环指令 - 通道2 (CH2)"

#### 对话框内容

```
┌─────────────────────────────────────┐
│ 添加循环指令 - 通道1 (CH1)          │
├─────────────────────────────────────┤
│ 泵类型:                               │
│ ○ 气泵 💨    ○ 液泵1 💧   ○ 液泵2 💧 │
│                                     │
│ PWM值 (0-255):                       │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ 128                                  │
│                                     │
│ 持续时间 (ms):                        │
│ [1000]     (范围: 100-65535)        │
│                                     │
│          [取消]        [确定]        │
└─────────────────────────────────────┘
```

#### 表单字段

##### 泵类型 (Pump Type)

**选项**:
- `0` - 气泵 💨
- `1` - 液泵1 💧
- `2` - 液泵2 💧

**说明**: 选择要在该通道执行的泵类型

##### PWM值 (PWM Value)

**类型**: 滑块 + 数字输入框
**范围**: 0-255
**默认值**: 128

**说明**: 设置泵的PWM功率值

##### 持续时间 (Duration)

**类型**: 数字输入框
**范围**: 100-65535 ms
**默认值**: 1000 ms
**步进**: 100 ms

**说明**: 设置该指令的执行时长

#### 确定动作

```
1. 验证输入
   - PWM: 0-255 ✓
   - 时间: 100-65535 ✓
   ↓
2. 调用 loopControl.addLoopStep()
   ↓
3. 发送 LOOP_ADD 命令
   ↓
4. 添加到 loopStore.sequence
   ↓
5. 关闭对话框
```

**发送的命令**:
```
[0xAA][0x55][0x14][0x05][CH][PUMP][PWM][TIME_H][TIME_L][CRC8]

示例: CH1 气泵 PWM=150 时间=2000ms
[0xAA][0x55][0x14][0x05][0x01][0x00][0x96][0x07][0xD0][CRC8]
```

---

### 序列表操作

#### 删除指令

**触发方式**: 点击表格中的删除按钮（红色X）

**动作**:
```
1. 从 loopStore.sequence 中删除该指令
   ↓
2. 更新 UI（表格自动刷新）
```

**注意**: 删除操作不发送命令到设备，只影响本地序列表

---

### 双通道状态显示

#### CH1 状态区域

```
┌─────────────────────────────────┐
│ 状态: 运行中 ✓ (绿色标签)        │
│ 进度: 2 / 5                     │
│ 循环: 3 / ∞                     │
└─────────────────────────────────┘
```

**字段说明**:

| 字段 | 说明 | 数据来源 |
|:-----|:-----|:--------|
| **状态** | 当前执行状态 | GET_LOOP_STATUS 响应 |
| - 停止 (灰色) | state = 0 | |
| - 运行中 (绿色) | state = 1 | |
| - 暂停 (黄色) | state = 2 | |
| **进度** | 当前执行第几条 / 共几条 | current / total |
| **循环** | 已执行几轮 / 共几轮 | loopCount / maxLoops |
| - `∞` 表示无限循环 | maxLoops = 0 | |

#### CH2 状态区域

**结构**: 与CH1相同

**数据来源**: 同CH1

---

### 状态轮询机制

**轮询频率**: 1秒/次

**轮询流程**:
```
每1秒:
  ↓
发送 GET_LOOP_STATUS 命令:
[0xAA][0x55][0x22][0x00][CRC8]
  ↓
接收 LOOP_STATUS_RSP (0x32):
[0xAA][0x55][0x32][0x0A][ST1][CU1][TO1][CN1][MX1][ST2][CU2][TO2][CN2][MX2][CRC8]
  ↓
解析双通道状态:
  ch1 = {
    state: ST1,      // 状态
    current: CU1,    // 当前索引
    total: TO1,      // 总数
    loopCount: CN1,  // 当前循环
    maxLoops: MX1    // 最大循环
  }
  ch2 = { ... }
  ↓
更新 loopStore.status
  ↓
UI 自动响应式更新
```

---

## 📜 6. 通信日志查看器 (LogViewer)

### 位置
- **文件**: `src/components/device/LogViewer.vue`
- **页面位置**: 右侧栏

### 功能

实时显示串口通信日志，方便调试和追踪

### 显示内容

```
┌───────────────────────────────────┐
│ 📜 通信日志                        │
├───────────────────────────────────┤
│ [15:30:45] ↓ TX: AA 55 10 03 01... │
│ [15:30:45] ↑ RX: AA 55 40 00 40   │
│ [15:30:46] ↓ TX: AA 55 21 00 8F   │
│ [15:30:46] ↑ RX: AA 55 31 06 01... │
│ ...                               │
└───────────────────────────────────┘
```

### 日志类型

| 标记 | 方向 | 说明 |
|:----:|:----:|:-----|
| `↓ TX` | 下行 | 上位机 → 下位机 |
| `↑ RX` | 上行 | 下位机 → 上位机 |
| `[时间戳]` | - | 精确到毫秒 |

### 显示格式

**下行命令 (TX)**:
```
[15:30:45] ↓ TX: AA 55 10 03 01 00 96 40
                  ↑    ↑  ↑  ↑  ↑  ↑  ↑
                  帧头  CMD LEN CH PUMP PWM CRC
```

**上行响应 (RX)**:
```
[15:30:45] ↑ RX: AA 55 31 06 01 00 96 00 00 00 03 9A
                  ↑    ↑  ↑  ↑  ↑  ↑  ↑  ↑  ↑  ↑  ↑
                  帧头  CMD LEN CH1(5字节)      CH2(5字节) CRC
```

### 自动滚动

**启用条件**: 默认启用

**行为**: 新日志到达时自动滚动到底部

**更新频率**: 实时（每次通信立即更新）

---

## 🛑 7. 紧急停止按钮 (EmergencyStop)

### 位置
- **文件**: `src/components/device/EmergencyStop.vue`
- **页面位置**: 左侧栏底部

### 功能

最高优先级的紧急控制，立即停止所有泵的运行

### 按钮样式

```
┌────────────────────────────────┐
│                                │
│      🛑 紧急停止所有泵          │  ← 红色大按钮
│                                │
└────────────────────────────────┘
```

### 点击动作

```
1. 弹出确认对话框:
   "确定要紧急停止所有泵吗？
    此操作将立即停止所有通道的运行。"
   ↓
2. 用户点击"确定停止"
   ↓
3. 发送 STOP_ALL 命令
   ↓
4. 显示成功消息: "紧急停止命令已发送"
```

### 发送的命令

```
[0xAA][0x55][0x12][0x00][CRC8]  - STOP_ALL
```

**优先级**: 最高（高于所有其他命令）

**响应**:
```
ACK (0x40) - 成功
NACK (0x41) + ERROR_CODE - 失败
```

**效果**:
- 立即停止所有通道的所有泵
- 清空循环模式状态
- 切换到指令模式
- 不影响串口连接

---

## 🔄 完整交互流程示例

### 场景1: 手动控制泵

```
用户操作流程:
1. 点击"连接串口"
   ↓
2. 选择串口并连接
   ↓
3. 点击 CH1 气泵卡片（PWM=150）
   ↓
4. 气泵开始运行（显示"运行中 ✓"）
   ↓
5. 拖动PWM滑块到 200
   ↓
6. 气泵功率更新（立即发送新PWM值）
   ↓
7. 再次点击 CH1 气泵卡片
   ↓
8. 气泵停止（显示"已停止"）
```

### 场景2: 循环模式执行

```
用户操作流程:
1. 在 CH1 区域点击"添加指令"
   ↓
2. 选择: 气泵, PWM=150, 时间=2000ms
   ↓
3. 点击"确定"
   ↓
4. CH1 序列表显示第1条指令
   ↓
5. 在 CH2 区域点击"添加指令"
   ↓
6. 选择: 液泵1, PWM=200, 时间=3000ms
   ↓
7. 点击"确定"
   ↓
8. CH2 序列表显示第1条指令
   ↓
9. 设置循环次数: 3
   ↓
10. 点击"开始执行"
    ↓
11. 两个通道开始并行执行
    ↓
12. 实时显示进度和状态
    - CH1: 运行中 ✓, 进度: 1/1, 循环: 2/3
    - CH2: 运行中 ✓, 进度: 1/1, 循环: 2/3
    ↓
13. 点击"暂停"
    ↓
14. 两个通道同时暂停
    ↓
15. 点击"继续"
    ↓
16. 两个通道恢复执行
    ↓
17. 执行完成（3轮循环后）
    ↓
18. 自动停止，显示"已停止"
```

### 场景3: 紧急停止

```
紧急情况流程:
1. 任意时刻点击"紧急停止所有泵"
   ↓
2. 弹出确认对话框
   ↓
3. 用户点击"确定停止"
   ↓
4. 发送 STOP_ALL 命令
   ↓
5. 所有泵立即停止
   ↓
6. 循环模式被清空
   ↓
7. 所有状态重置为"已停止"
```

---

## 📊 协议命令速查表

### 指令模式命令

| 命令码 | 名称 | 方向 | 触发方式 | 页面位置 |
|:------:|:-----|:----:|:--------:|:--------:|
| 0x10 | SET_PUMP | ↓ | 点击泵卡片 | 泵控制 |
| 0x11 | STOP_CHANNEL | ↓ | 点击运行中的泵卡片 | 泵控制 |
| 0x12 | STOP_ALL | ↓ | 紧急停止按钮 | 左侧栏底部 |
| 0x20 | GET_VERSION | ↓ | 连接后自动 | 系统自动 |
| 0x21 | GET_STATUS | ↓ | 1秒轮询 | 系统自动 |
| 0x50 | HEARTBEAT | ↔ | 1秒发送 | 系统自动 |

### 循环模式命令

| 命令码 | 名称 | 方向 | 触发方式 | 页面位置 |
|:------:|:-----|:----:|:--------:|:--------:|
| 0x14 | LOOP_ADD | ↓ | 添加指令并确定 | LoopManager |
| 0x15 | LOOP_CLEAR | ↓ | 清空所有 | LoopManager |
| 0x16 | LOOP_START | ↓ | 开始执行 | LoopManager |
| 0x17 | LOOP_STOP | ↓ | 停止 | LoopManager |
| 0x18 | LOOP_PAUSE | ↓ | 暂停 | LoopManager |
| 0x19 | LOOP_RESUME | ↓ | 继续 | LoopManager |
| 0x22 | GET_LOOP_STATUS | ↓ | 1秒轮询 | 系统自动 |

### 响应命令

| 命令码 | 名称 | 方向 | 内容 |
|:------:|:-----|:----:|:-----|
| 0x30 | VERSION_RSP | ↑ | 硬件版本、固件版本、设备名称 |
| 0x31 | STATUS_RSP | ↑ | 工作模式、CH1状态、CH2状态 |
| 0x32 | LOOP_STATUS_RSP | ↑ | CH1状态、CH2状态（10字节） |
| 0x40 | ACK | ↑ | 确认响应 |
| 0x41 | NACK | ↑ | 错误响应 + 错误码 |

---

## 🎨 UI状态映射

### 连接状态

| 状态 | 按钮 | 指示器 | 日志查看器 |
|:----:|:----:|:------:|:---------:|
| 未连接 | "连接串口" | 显示"--" | 禁用 |
| 已连接 | "断开连接" | 显示版本信息 | 启用 |
| 连接中 | "连接中..." | 显示"--" | 禁用 |

### 泵状态

| 状态 | 卡片样式 | 状态标签 | 边框 | 背景 |
|:----:|:--------:|:--------:|:----:|:----:|
| 未运行 | 灰色 | "已停止" (蓝色) | 灰色 | 白色 |
| 运行中 | 渐变紫 | "运行中 ✓" (绿色) | 绿色 | 渐变紫 |

### 循环状态

| 状态 | 开始按钮 | 暂停按钮 | 停止按钮 |
|:----:|:--------:|:--------:|:--------:|
| 未运行 | 启用 | 禁用 | 禁用 |
| 运行中 | 禁用 | 启用 | 启用 |
| 已暂停 | 禁用 | 禁用(显示"继续") | 启用 |

---

## 🔐 安全机制

### 1. 心跳保活

**机制**: 每1秒发送心跳包，3秒无响应自动停止

**命令**:
```
[0xAA][0x55][0x50][0x00][CRC8]  - HEARTBEAT
```

**响应**:
```
[0xAA][0x55][0x50][0x00][CRC8]  - HEARTBEAT 响应
```

### 2. CRC8 校验

**作用**: 所有命令和响应都带有CRC8校验

**算法**:
- 多项式: 0x07
- 初始值: 0x00
- 校验范围: CMD + LEN + DATA

### 3. 错误处理

| 错误码 | 错误类型 | 处理方式 |
|:------:|:--------|:--------:|
| 0x01 | CRC 校验错误 | 丢弃数据包 |
| 0x02 | 命令不支持 | 显示错误提示 |
| 0x03 | 参数错误 | 显示错误提示 |
| 0x04 | 通道号错误 | 显示错误提示 |
| 0x05 | 泵类型错误 | 显示错误提示 |
| 0x06 | 硬件故障 | 显示严重错误 |
| 0x08 | 模式冲突 | 提示切换模式 |
| 0x09 | 泵冲突 | 提示停止其他泵 |

---

## 📝 使用建议

### 日常操作流程

1. **连接设备**
   - 点击"连接串口"
   - 等待版本信息显示

2. **选择工作模式**
   - 指令模式: 直接点击泵卡片控制
   - 循环模式: 添加指令后点击"开始执行"

3. **监控状态**
   - 观察泵状态标签
   - 查看通信日志
   - 注意心跳状态

4. **紧急情况**
   - 点击红色"紧急停止"按钮
   - 确认后立即停止所有泵

### 调试技巧

1. **查看通信日志**
   - 右侧栏实时显示所有命令
   - 十六进制格式便于分析

2. **观察状态变化**
   - 泵状态标签实时更新
   - 循环模式显示详细进度

3. **检查心跳**
   - 心跳状态显示在设备状态区域
   - 超时会有红色警告

---

## 📚 相关文档

### 技术文档
- `液动通讯协议.md` - 完整协议规范
- `PHASE4_V1.3_REFACTORING.md` - Timeline执行引擎
- `LOOP_MANAGER_UI_REFACTORING.md` - LoopManager UI重构

### 版本文档
- `UPDATE_v1.3.md` - v1.3 版本更新（双通道循环）
- `UPDATE_v1.4.md` - v1.4 版本更新
- `UPDATE_v1.5.md` - v1.5 版本更新（固件上传）

---

**文档版本**: 1.0
**最后更新**: 2025-01-15
**作者**: Claude Code
**状态**: ✅ 完整
**对应代码版本**: v1.6
