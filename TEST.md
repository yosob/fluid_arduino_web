# 液动控制系统 Web 上位机 - 测试文档

## 📋 目录

- [环境准备](#环境准备)
- [安装步骤](#安装步骤)
- [功能测试](#功能测试)
- [测试用例](#测试用例)
- [常见问题](#常见问题)
- [测试记录](#测试记录)

---

## 🔧 环境准备

### 1. 硬件要求

- ✅ Arduino 开发板（已烧录下位机代码）
- ✅ USB 数据线（连接 Arduino 到电脑）
- ✅ 2 个通道的气液泵硬件连接

### 2. 软件要求

- ✅ Node.js >= 18.0.0
- ✅ Chrome 或 Edge 浏览器（支持 Web Serial API）
- ✅ npm >= 9.0.0

### 3. 下位机准备

确认 Arduino 已正确烧录以下代码：
- `reference/yedong/yedong.ino`
- 模式开关置于 ONLINE 位置（高电平）

---

## 📥 安装步骤

### 步骤 1: 安装依赖

```bash
cd fliud_v0_web
npm install
```

**预期结果:**
- 下载并安装所有依赖包（约 2-3 分钟）
- 无错误提示

### 步骤 2: 启动开发服务器

```bash
npm run dev
```

**预期结果:**
```
VITE v5.0.0  ready in xxx ms

➜  Local:   http://localhost:5173/
➜  Network: use --host to expose
➜  press h to show help
```

### 步骤 3: 打开浏览器

1. 自动打开浏览器，或手动访问 `http://localhost:5173`
2. 检查页面是否正常显示
3. 打开浏览器开发者工具（F12）查看控制台

**预期结果:**
- 页面标题显示"液动控制系统 v1.0"
- 界面包含设备状态、通道控制、循环模式等模块
- 无控制台错误

---

## ✅ 功能测试

### 测试模块 1: 串口连接

#### 测试 1.1: 串口连接

**步骤:**
1. 点击"连接串口"按钮
2. 浏览器弹出串口选择对话框
3. 选择对应的 Arduino 串口（通常是 COM3、COM4 等）

**预期结果:**
- ✅ 按钮文本变为"断开连接"
- ✅ 设备状态显示"已连接 ✓"
- ✅ 自动获取并显示硬件版本、固件版本、设备名称
- ✅ 心跳状态显示"正常 ✓"

#### 测试 1.2: 串口断开

**步骤:**
1. 点击"断开连接"按钮

**预期结果:**
- ✅ 按钮文本变回"连接串口"
- ✅ 设备状态显示"未连接"
- ✅ 硬件/固件版本显示"-"

---

### 测试模块 2: 设备状态监控

#### 测试 2.1: 版本信息获取

**检查项:**
- [ ] 硬件版本显示正确（如 1.0）
- [ ] 固件版本显示正确（如 1.0）
- [ ] 设备名称显示正确（如 "fluid V0"）

#### 测试 2.2: 心跳保活

**步骤:**
1. 观察心跳状态指示
2. 等待 5-10 秒

**预期结果:**
- ✅ 心跳状态持续显示"正常 ✓"
- ✅ 无"心跳超时"警告

#### 测试 2.3: 连接状态异常处理

**步骤:**
1. 拔掉 Arduino USB 线
2. 观察页面变化

**预期结果:**
- ✅ 3 秒后显示"心跳超时"警告
- ✅ 设备状态显示错误提示

---

### 测试模块 3: 通道泵控制

#### 测试 3.1: 启动气泵

**步骤:**
1. 在"通道 1"中点击"气泵"卡片
2. 调整 PWM 滑块到 128
3. 观察卡片状态变化

**预期结果:**
- ✅ 卡片背景变为渐变色（运行状态）
- ✅ 显示"运行中 ✓"标签
- ✅ PWM 值显示为 128
- ✅ Arduino 上对应引脚输出 PWM 信号

#### 测试 3.2: 调整 PWM 值

**步骤:**
1. 在运行状态下拖动 PWM 滑块
2. 从 128 调整到 200

**预期结果:**
- ✅ PWM 显示值实时更新
- ✅ Arduino PWM 输出实时变化

#### 测试 3.3: 切换泵类型

**步骤:**
1. 当前运行气泵
2. 点击"液泵1"卡片

**预期结果:**
- ✅ 气泵自动停止
- ✅ 液泵1 开始运行
- ✅ 单通道内只有一个泵工作

#### 测试 3.4: 停止泵

**步骤:**
1. 点击正在运行的泵卡片

**预期结果:**
- ✅ 泵停止运行
- ✅ 卡片恢复默认样式
- ✅ 显示"已停止"标签

#### 测试 3.5: 双通道独立控制

**步骤:**
1. 通道 1 启动气泵
2. 通道 2 启动液泵1

**预期结果:**
- ✅ 两个通道同时运行不同的泵
- ✅ 互不干扰

---

### 测试模块 4: 循环模式

#### 测试 4.1: 添加时序指令

**步骤:**
1. 点击"添加"按钮
2. 填写表单：
   - 通道: CH1
   - 泵类型: 液泵1
   - PWM: 153
   - 时间: 1000ms
3. 点击"确定"

**预期结果:**
- ✅ 时序表中新增一条记录
- ✅ 显示正确的通道、泵类型、PWM、时间

#### 测试 4.2: 添加多条指令

**步骤:**
1. 重复"添加"操作，添加以下指令：
   - 指令 1: CH1 液泵1 PWM=153 时间=1000ms
   - 指令 2: CH1 液泵2 PWM=204 时间=2000ms
   - 指令 3: CH1 气泵 PWM=128 时间=1000ms

**预期结果:**
- ✅ 时序表显示 3 条指令
- ✅ 序号从 1 到 3

#### 测试 4.3: 开始循环执行

**步骤:**
1. 点击"开始"按钮

**预期结果:**
- ✅ 循环开始运行
- ✅ 执行进度条显示
- ✅ "开始"按钮变为禁用状态
- ✅ 硬件按顺序执行时序

#### 测试 4.4: 查看执行进度

**步骤:**
1. 观察执行进度和循环次数

**预期结果:**
- ✅ 当前执行序号实时更新（如 2/3条）
- ✅ 循环次数显示（如"无限循环 (已执行5次)"）

#### 测试 4.5: 暂停/继续循环

**步骤:**
1. 点击"暂停"按钮
2. 观察状态
3. 点击"继续"按钮

**预期结果:**
- ✅ 暂停后显示"已暂停"标签
- ✅ 硬件保持当前状态
- ✅ 继续后恢复执行

#### 测试 4.6: 停止循环

**步骤:**
1. 点击"停止"按钮

**预期结果:**
- ✅ 循环停止
- ✅ 所有泵停止工作
- ✅ 进度信息消失

#### 测试 4.7: 清空时序表

**步骤:**
1. 点击"清空"按钮
2. 确认操作

**预期结果:**
- ✅ 时序表清空
- ✅ 循环状态重置

---

### 测试模块 5: 紧急停止

#### 测试 5.1: 紧急停止所有泵

**前置条件:**
- 两个通道都在运行泵

**步骤:**
1. 点击"🛑 紧急停止所有泵"按钮
2. 在确认对话框中点击"确定停止"

**预期结果:**
- ✅ 所有通道立即停止
- ✅ 弹出"紧急停止命令已发送"提示
- ✅ 所有泵卡片显示"已停止"

---

### 测试模块 6: 错误处理

#### 测试 6.1: CRC 校验错误

**模拟方法:**
- 人为修改协议代码，发送错误的 CRC

**预期结果:**
- ✅ 控制台输出 CRC 校验失败日志
- ✅ 设备继续正常运行

#### 测试 6.2: 参数错误

**步骤:**
1. 尝试设置无效的 PWM 值（通过控制台）
2. 观察响应

**预期结果:**
- ✅ 收到 NACK 响应
- ✅ 显示错误提示

#### 测试 6.3: 串口断开

**步骤:**
1. 在运行过程中拔掉 USB 线
2. 观察系统行为

**预期结果:**
- ✅ 心跳超时警告（3秒后）
- ✅ 自动停止所有泵（下位机保护机制）
- ✅ 显示设备已断开

---

## 🧪 测试用例

### 测试用例 1: 完整工作流程

**目标:** 测试从连接到控制的完整流程

**步骤:**
1. 打开页面
2. 连接串口
3. 启动 CH1 液泵1（PWM=150）
4. 运行 5 秒
5. 切换到 CH1 液泵2（PWM=200）
6. 运行 5 秒
7. 停止 CH1
8. 断开串口

**预期结果:**
- ✅ 所有步骤正常执行
- ✅ 无错误提示
- ✅ 硬件响应正确

---

### 测试用例 2: 循环模式完整流程

**目标:** 测试循环模式的完整功能

**步骤:**
1. 连接串口
2. 添加 4 条时序指令：
   - CH1 液泵1 PWM=153 时间=1000ms
   - CH1 液泵2 PWM=204 时间=2000ms
   - CH1 气泵 PWM=128 时间=1000ms
   - 停止所有泵 时间=0ms
3. 启动循环（无限循环）
4. 观察执行 3 个循环
5. 暂停循环
6. 继续循环
7. 停止循环
8. 断开串口

**预期结果:**
- ✅ 时序按顺序执行
- ✅ 时间控制准确
- ✅ 暂停/继续功能正常
- ✅ 循环次数正确

---

### 测试用例 3: 异常情况处理

**目标:** 测试系统异常处理能力

**步骤:**
1. 连接串口
2. 启动 CH1 气泵
3. 拔掉 USB 线
4. 等待 5 秒
5. 重新插上 USB 线
6. 刷新页面
7. 重新连接串口

**预期结果:**
- ✅ 断开时显示心跳超时
- ✅ 重新连接后恢复正常
- ✅ 无内存泄漏

---

## ❓ 常见问题

### 问题 1: Web Serial API 不工作

**症状:**
- 点击"连接串口"按钮无反应
- 控制台显示 "serial is not defined"

**解决方案:**
1. 确认使用 Chrome 或 Edge 浏览器
2. 确认通过 `https://` 或 `http://localhost` 访问
3. 更新浏览器到最新版本

---

### 问题 2: 串口连接失败

**症状:**
- 浏览器弹出串口选择对话框
- 选择串口后连接失败

**解决方案:**
1. 检查 Arduino 是否正确连接
2. 确认串口未被其他程序占用（如 Arduino IDE 串口监视器）
3. 尝试重新插拔 USB 线
4. 在设备管理器中检查串口驱动

---

### 问题 3: 心跳超时

**症状:**
- 连接成功但 3 秒后显示心跳超时
- 设备状态显示错误

**解决方案:**
1. 确认 Arduino 下位机代码已正确烧录
2. 检查模式开关是否在 ONLINE 位置（高电平）
3. 打开 Arduino IDE 串口监视器（115200 波特率）查看调试信息
4. 确认下位机心跳响应正常

---

### 问题 4: 泵不工作

**症状:**
- 点击泵卡片后显示"运行中"
- 但实际硬件无反应

**解决方案:**
1. 确认模式开关在 ONLINE 位置
2. 检查 PWM 值是否在 0-255 范围内
3. 检查 Arduino 引脚连接
4. 使用万用表测量 PWM 输出
5. 查看下位机串口调试信息

---

### 问题 5: CRC 校验失败

**症状:**
- 控制台频繁输出 CRC 校验失败
- 命令无响应

**解决方案:**
1. 检查串口通信是否稳定
2. 确认波特率设置正确（115200）
3. 检查 USB 线质量
4. 尝试更换 USB 线或串口

---

## 📊 测试记录

### 测试环境

- **测试日期**: ___________
- **测试人员**: ___________
- **硬件版本**: ___________
- **固件版本**: ___________
- **浏览器**: ___________
- **操作系统**: ___________

### 测试结果汇总

| 测试模块 | 测试用例数 | 通过数 | 失败数 | 通过率 |
|---------|----------|-------|-------|--------|
| 串口连接 |   2   |   ?   |   ?   |   ?%   |
| 设备状态 |   3   |   ?   |   ?   |   ?%   |
| 泵控制   |   5   |   ?   |   ?   |   ?%   |
| 循环模式 |   7   |   ?   |   ?   |   ?%   |
| 紧急停止 |   1   |   ?   |   ?   |   ?%   |
| 错误处理 |   3   |   ?   |   ?   |   ?%   |
| **总计** |  **21** |  **?** |  **?** |  **?%** |

### Bug 记录

| 编号 | 问题描述 | 严重程度 | 状态 | 备注 |
|-----|---------|---------|------|------|
| 1   |         |         |      |      |
| 2   |         |         |      |      |
| 3   |         |         |      |      |

**严重程度:**
- 🔴 严重：影响主要功能，必须修复
- 🟡 中等：影响部分功能，建议修复
- 🟢 轻微：不影响主要功能，可选修复

---

## 🎯 性能测试

### 响应时间测试

| 操作 | 预期响应时间 | 实际响应时间 | 是否达标 |
|-----|------------|------------|---------|
| 串口连接 | < 3s | ? | ? |
| 启动泵   | < 100ms | ? | ? |
| 停止泵   | < 100ms | ? | ? |
| 紧急停止 | < 50ms | ? | ? |
| 心跳响应 | < 10ms | ? | ? |

---

## 📝 测试建议

1. **逐步测试**: 按照模块顺序测试，不要跳过
2. **记录详细**: 详细记录测试过程和结果
3. **多次测试**: 关键功能需要多次测试确保稳定性
4. **异常测试**: 不仅要测试正常流程，还要测试异常情况
5. **硬件检查**: 定期检查硬件连接和状态
6. **日志分析**: 利用浏览器控制台和 Arduino 串口监视器分析问题

---

## ✅ 测试完成检查清单

在确认测试完成之前，请确认以下所有项目：

### 功能完整性
- [ ] 串口连接/断开正常
- [ ] 设备信息获取正确
- [ ] 心跳保活机制正常
- [ ] 单通道泵控制正常
- [ ] 双通道独立控制正常
- [ ] PWM 调节实时有效
- [ ] 循环模式功能完整
- [ ] 紧急停止立即生效
- [ ] 错误处理机制完善

### 用户体验
- [ ] 界面美观、布局合理
- [ ] 操作流畅、响应及时
- [ ] 提示信息清晰准确
- [ ] 无明显卡顿或延迟
- [ ] 适配不同屏幕尺寸

### 代码质量
- [ ] 无控制台错误
- [ ] 无内存泄漏
- [ ] 代码结构清晰
- [ ] 注释完整
- [ ] 符合编码规范

---

**测试完成签名:** ___________

**日期:** ___________

**备注:**

_____________________________________________________________________

_____________________________________________________________________

---

**文档版本:** 1.0
**最后更新:** 2025-01-14
**维护者:** 液动工具包项目组
